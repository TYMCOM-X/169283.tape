MODULE RSSRT(DOLLAR,ENTRIES=($RSSRT),FSAVE,TIMING,TIMER=EXTERNAL(SIX12))=

BEGIN

REQUIRE STDEFS.BLI[7,107355];
REQUIRE RCDEFS.BLI[7,107355];
REQUIRE RDEFS.BLI[7,107355];
REQUIRE DBDEFS.BLI[7,107355];
REQUIRE UDEFS.BLI[7,107355];
REQUIRE CDEFS.BLI[7,107355];
REQUIRE KDEFS.BLI[7,107355];
REQUIRE BTDEFS.BLI[7,107355];
UNDECLARE $RSSRT;

GLOBAL ROUTINE $RSSRT(RCB)=

   BEGIN
   MAP RCB$ RCB;
   LOCAL ST$ ST;
   LOCAL KFCB$ FCB:FC;
   LOCAL KSOB$ SOB;
   LOCAL KDB$ DB;
   LOCAL ISIZ,N,NINBUF;
   BIND NCRVL = PLIT(4,13,40,121,364,1093);

   FC_.RCB[RC$FCB];
   FC[K$SOBP]_SOB_.RCB[RC$SOBP];
   ISIZ_.SOB[K$SISIZ];


   IF NOT .RCB[RC$WHERE]
      THEN
         BEGIN
         N_7*.FC[K$BLKSIZ]-$KNFRE();
         IF .N GTR 0
            THEN $KALBF(.N);
         NINBUF_$KNFRE()/.FC[K$BLKSIZ]-1;
         END
      ELSE NINBUF_3;

   ST_RCB[RC$SCONTRL]_$CGTZM(STV$SIZE+(.NINBUF-3)/2);

   ST[ST$NINBUF]_.NINBUF;

   FCB_ST[ST$FCB1]_$KCRFCBNOC($CTIME()*#10000 OR $CPJOB(),SIXBIT 'TMP',
                           0,KV$FDX,$KINIT,.ST);

   FCB[K$BLKSIZ]_.FC[K$BLKSIZ];
   ST[ST$NOP]_1;
   DB_ST[ST$BUFA]_$KGBUF(.FCB,0);
   DB[DB$NUMBER]_0;
   DB[DB$OFF]_ST[ST$OFF]_KV$PAGS*.FCB[K$BLKSIZ]-.SOB[K$SDBMENT]*.ISIZ;
   $KVIWR(.FCB,.DB,0);
   $KPRON(.FCB,.DB,0);
   ST[ST$BUFN]_1;
   IF NOT .RCB[RC$WHERE]
      THEN
         BEGIN
         ST[ST$PTARR]_$CGETM(.SOB[K$SDBMENT]*.ST[ST$NINBUF]);
         INCR I FROM 1 TO 5
            DO IF .NCRVL[.I] GEQ .SOB[K$SDBMENT]*4
               THEN
                  BEGIN
                  ST[ST$NARSZ]_.I;
                  RETURN
                  END;
         END;
   END;
END ELUDOM
