100 '     S O R T
110 '     -------
112 '
114 '     COMPANY PROPRIETARY, LUPFER & LONG COMPUTER SERVICES
120 '
122 '	VERSION 1.2
124 '
130 DIM F$(10)
140 DIM K$(100),P(100)
145 '
147 P1=1			'INPUT FILE POINTER
148 '
150 FILE #3, "COMCOM.TMP"
160 MAT READ #3, F$
190 FILE #3, "COMMOD.TMP"
192 READ #3,W1$,W2$,W3$,W4$,L1,R1,E9
200 FILE :1: W1$		'INPUT (KEYS ONLY)
202 FILE :2: W2$
204 FILE :3: W3$
205   SCRATCH :2
215   SCRATCH :3
220 T1=(LEN(W1$)-7)/2
222 K1$=RIGHT$(W1$,T1)
224 K1=VAL(K1$)-6
225 REM =========== INITIALIZATION ==========
230 IF F$(2)<>"LAST" GO TO 250
240   S2=1
250 B9=100
270 P1=1		'RECORD COUNTER
280 M1=0
290 M2=3
300 M3=2
310 K9$=CHR$(122)		'HIGH VALUE
320 REM ======= SET-UP SORT =========
330 X=1
340 C=0
350 T1=0
360 FOR I=0 TO B9
370   P(I)=0
380 NEXT I
390 REM -------- BEGIN SORT ----------
400 IF P1>L1 THEN 620		'EOF
410 READ :1: K$(X)
420 P1=P1+1			'COUNT RECORDS
450 IF K$(X)>=K$(C) THEN 510
460 C=P(0)
470 IF K$(X)>=K$(C) THEN 510
480 T1=P(0)
490 C=0
500   GO TO 560
510 T1=P(C)
520 IF T1=0 THEN 560
530 IF K$(T1)>K$(X) THEN 560
540 C=T1
550   GO TO 510
560 P(X)=T1
570 P(C)=X
580 C=X
590 X=X+1
600 IF X<=B9 THEN 400
610 IF P1<=L1 THEN 640		'NOT THE LAST RECORD
620 REM ========== MERGE ============
630 F$="EOF"
640 X=P(0)
660 T1=M2
670 M2=M3
680 M3=T1
690 SET :2, 1
700 SET :3, 1
780 W$=K9$
790 C$=K$(X)
800 IF M1=0 THEN 820
810 GOSUB 1710		'READ
815 '			FIND LOWEST KEY
820 IF C$>W$ THEN 850
830 L$=C$
840   GO TO 860
850 L$=W$
860 IF L$=K9$ THEN 1060
870 REM ----- TAKE FROM WORKFILE --------
880 IF W$>L$ THEN 950
890 ON M3 GO TO 9000,900,910
900 WRITE :2: W$
905   GO TO 920
910 WRITE :3: W$
920 GOSUB 1710		'READ
930 IF W$<K9$ THEN 870
940   GO TO 820
950 REM ----- TAKE FROM CORE ------------
960 IF C$>L$ THEN 820
970 ON M3 GO TO 9000,980,990
980 WRITE :2: C$
985   GO TO 1000
990 WRITE :3: C$
1000 IF P(X)>0 THEN 1030
1010 C$=K9$
1020   GO TO 820
1030 X=P(X)
1040 C$=K$(X)
1050   GO TO 950
1060 REM ---- MERGE PASS DONE ---------
1066 GOSUB 1500
1070 M1=M1+1
1080 IF F$<>"EOF" GO TO 320
1090 REM ========= WRAP-UP ===========
1130 SET :2, 1
1140 SET :3, 1
1150 M2=M3
1160 '
1161 FILE :4: F$(7)		'OUTPUT
1162 IF F$(7) <> F$(4) THEN 1186
1164 '			COPY OLD FILE INTO TEMPORARY FILE
1165 FILE :1: W4$		'DEFINE TEMP FILE
1168 SCRATCH :1
1170 IF END :4 GO TO 1190
1172 READ :4: I$		'OLD
1174 WRITE :1: I$		'TEMPORARY
1176   GO TO 1170
1184 '
1186 FILE :1: F$(4)
1190 SCRATCH :4
1200 SET :1,1		'COPY HEADER
1201 FOR X=1 TO R1
1202 READ :1: I$
1204 WRITE :4: I$
1205 NEXT X
1206 X=1
1208 P1=1
1210 IF S2=0 THEN 1260
1212 '			ELIMINATE DUPLICATE KEYS
1214 '
1216 GOSUB 1700			'READ WORKFILE (1ST TIME)
1218 GOSUB 3600			'EXTRACT KEY AND POINTER
1220 X=3-X			'FLIP POINTER
1222 GOSUB 1700
1224 GOSUB 3600			'EXTRACT KEY AND POINTER
1230 Y=3-X
1232 IF K$(3-X) = K$(X) THEN 1220	'TIE
1234 GOSUB 1300 		'COPY A RECORD
1240 IF P(X)<>999999 THEN 1220
1242   GO TO 1400 		'EOF
1250 '
1260 '			NORMAL SORT - KEEP DUPLICATES
1262 '
1264 Y=1
1270 GOSUB 1700			'READ WORKFILE
1272 GOSUB 3600
1274 IF P(X)=999999 THEN 1400	'EOF
1280 GOSUB 1300 		'COPY A RECORD
1282   GO TO 1270
1290 '
1300 '			COPY RECORD ROUTINE
1305 T1=0
1310 SET:1, P(Y)
1320 READ :1: I$
1330 WRITE :4: I$
1340 T1=T1+1
1350 IF T1<R1 THEN 1320
1360   RETURN
1399 '
1400 '			 END OF FILE
1410 IF E9=0 THEN 1450
1412 SET :1: E9		'ONLY IF "EOF" RECORD EXISTS
1420 READ :1: W$
1430 WRITE :4: W$
1450 CHAIN F$(10)+F$(9)
1499 '
1500 REM ---------- WRITE WORKFILE ------------
1510 ON M3 GO TO 9000,1560,1600
1560 WRITE :2: K9$
1590   GO TO 1690
1600 WRITE :3: K9$
1690 RETURN
1700 REM ---------- READ WORKFILE ------------
1701 '			LAST PASS ONLY
1702 IF P1>L1 THEN 1880
1704 P1=P1+1
1709 '			NORMAL ENTRY POINT
1710 ON M2 GO TO 9000,1760,1800
1760 IF END :2 GO TO 1870
1770 READ :2: W$
1790   GO TO 1890
1800 IF END :3 GO TO 1870
1810 READ :3: W$
1830   GO TO 1890
1870 PRINT 1870;M2
1872 PRINT W$
1875   GO TO 9000
1880 T$=SPACE$(K1)
1882 T1$="999999"
1884 W$=T$ + T1$		'CREATE A FAKE EOF RECORD
1890   RETURN
3600 '			EXTRACT KEY AND POINTER
3610 T$=RIGHT$(W$,6)		'POINTER
3620 P(X)=VAL(T$)
3630 K$(X)=LEFT$(W$,K1)		'KEY
3640   RETURN
9000 REM ========== SYSTEM ERROR ===========
9010 PRINT "* PROGRAM ERROR * SORT *"
9020   STOP
9999 END
