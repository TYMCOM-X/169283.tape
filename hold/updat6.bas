100 '     U P D A T E
101 '
102 '     COMPANY PROPRIETARY, LUPFER & LONG
103 '
104 '     UPDAT6 - VERSION 1.0
105 '
110 DIM F$(10),G$(10),G(4)
120 DIM O(132),I(132)
130 DIM F(16,15),H(72)
140 DIM A(12,4),T(30)
150 '
180 REM ---INITIALIZE---
190 FILE #1, "COMCOM.TMP"
200 MAT READ #1, F$
210 '
230 FILE :1: F$(3)		'  .MST
240   GOSUB 8000
250 FILE :4: F$(5)		'  .COA
260   GOSUB 8500		'  READ .COA HEADER
270 FILE :2: F$(4)		'  .MDT
280   READ :2: I1$
290   READ :2: I2$		'  PRIME
292 '
295 L1=F(13,H(10))
300 L2=F(6,H(10))
310 L3=F(13,H(13))
320 L4=F(6,H(13))
330 X1=G4-G6
340 REM ------ GET .COA ACCOUNT ----------
345 IF END :4 GO TO 1030
350 READ :4: I$
360 G$(1)=LEFT$(I$,8)
365 READ :4: G$(5)
370   IF X1>0 GO TO 410
380     S$=MID$(I$,14,10)	'  ORIGINAL BALANCE
390     GO TO 420
410   S$=MID$(G$(5),10*X1,10)
420   CHANGE S$ TO T
422   T(0)=11
424   T(11)=ASC(SP)
426   IF T(10)<=ASC(9) GO TO 430
427     T(11)=ASC(-)
428     T(10)=T(10)-10
430   A9=1
435   GOSUB 5600		'  CLEAR
440   GOSUB 5000
450   SET :2, LOC(2)-1
460 REM ---READ DATA FILE---
480 IF END :2 THEN 720
490 READ :2: I2$
530 IF I2$="EOF" THEN 720
540 S$=MID$(I2$,L1,L2)
560 IF S$=G$(1) THEN 670
570 IF S$>G$(1) THEN 720
590 PRINT "SEARCH ERROR - S$=";S$;" G$(1)=";G$(1)
600   GO TO 9000
670 S$=MID$(I2$,L3,L4)
680 CHANGE S$ TO T
690 A9=1
700 GOSUB 5000
710   GO TO 460
720 REM ---------- WRITE .COA ------------
880   A9=1
882   GOSUB 5200
883 '
884   A9=2			'  ACCUM GRAND TOTALS
886   IF T(12)<>ASC(-) GO TO 890
888     A9=3
890   GOSUB 5000
891 '
892   IF T(12)<>ASC(-) GO TO 900
894     T(11)=T(11)+10
900 CHANGE G$(5) TO O
902 K2=10*(X1+1)-1
905 IF K2>=9 GO TO 908
906   PRINT 906
907   GO TO 9000
908 FOR K1=1 TO 10
910   O(K1+K2)=T(K1+1)
920 NEXT K1
930 IF T(1)=ASC(0) GO TO 940
932     PRINT "COA OVERFLOW"
934     GO TO 9000
940   CHANGE O TO O$
950   SET :4, LOC(4)-1
960   WRITE :4: O$
970 GO TO 340
1030 REM ========= WRAP-UP ==================
1036 PRINT TAB(34);"DEBIT";TAB(53);"CREDIT"
1038 PRINT
1050 FOR A9=2 TO 3
1060   GOSUB 5200
1070   IF A9=2 GO TO 1085
1080     T(T(0))=ASC(SP)
1085   GOSUB 2700
1090   CHANGE T TO S$(A9)
1110 NEXT A9
1120 PRINT "BALANCE (ALL ACCOUNTS)  ";S$(2);TAB(44);S$(3)
1200 REM ------ RE-WRITE .COA HEADER --------
1210 SET :4, 1
1220 CHANGE G1$ TO O
1230 O(13)=G4-G6+1
1240 O(15)=1
1260 GOSUB 6000
1270 CHANGE O TO O$
1280 WRITE :4: O$
1400 REM ---------- DONE ------------
1410 CHAIN F$(10)+F$(9)
2000 REM ========== SUBROUTINES =============
2010 '
2700 REM -------- $ FORMAT --------
2710 K1=T(0)
2720 T(0)=T(0)+INT(K1/3)
2730 FOR K2=1 TO T(0)
2740   IF INT(K2)=4*INT(K2/4) GO TO 2780
2750     T(T(0)+1-K2)=T(K1)
2760     K1=K1-1
2770     GO TO 2790
2780   T(T(0)+1-K2)=ASC(,)
2790 NEXT K2
2800 T(T(0)-3)=ASC(.)
2810 V3=4
2820 GOSUB 2900
2890 RETURN
2900 REM ------ LEFT STRIP --------
2910 FOR K1=1 TO T(0)-V3
2920   IF T(K1)>ASC(0) GO TO 2950
2930   T(K1)=32
2940 NEXT K1
2950 RETURN
5000 REM ---ACCUMULATE---
5010 A1=13-T(0)
5020 A2=1
5030 IF T(13-A1)<>ASC(-) THEN 5050
5040 A2=-1
5050 FOR A8=A1 TO 11
5060   IF T(A8-A1+1)=ASC(0) THEN 5100
5070   A4=T(A8-A1+1)-48
5080   A5=INT((A2*A4)+.5)
5090   A(A8,A9)=A(A8,A9)+A5
5100 NEXT A8
5110   RETURN
5199 REM
5200 REM ---READ ACCUMULATOR---
5210 T(12)=32
5220 FOR A8=11 TO 1 STEP -1
5230   A1=0
5240   IF A(A8,A9)=0 THEN 5260
5250   A1=A(A8,A9)/10
5260   A2=INT(A1)
5270   A(A8-1,A9)=A(A8-1,A9)+A2
5280   A(A8,A9)=INT(.5+10*(A1-A2))
5290 NEXT A8
5300 IF A(0,A9)=0 THEN 5350
5310 A(11,A9)=A(11,A9)-1
5320 A(0,A9)=0
5330 T(12)=ASC(-)
5340   GO TO 5220
5350 FOR A8=1 TO 11
5360   IF T(12)<>ASC(-) THEN 5390
5370   T(A8)=ASC(0)+9-A(A8,A9)
5380     GO TO 5400
5390   T(A8)=ASC(0)+A(A8,A9)
5400 NEXT A8
5410 T(0)=12
5420 IF T(12)<>ASC(-) THEN 5450
5430 A(0,A9)=-1
5440 A(11,A9)=A(11,A9)+1
5450 FOR I=1 TO T(0)-2
5460   IF T(I)<>ASC(0) GO TO 5480
5470 NEXT I
5480 RETURN
5600 REM ---CLEAR ACCUMULATOR---
5610 FOR A8=0 TO 12
5620   A(A8,A9)=0
5630 NEXT A8
5640   RETURN
6000 REM --- KLUDGE CHAR SET FOR PDP-10 ---
6010 FOR K1=1 TO O(0)
6020   IF O(K1)>13 GO TO 6040
6030     O(K1)=100+O(K1)
6040 NEXT K1
6050 RETURN
6100 REM ---- UNKLUDGE PDP-10 CHARS -----
6110 FOR K1=1 TO I(0)
6120   IF I(K1)<100 GO TO 6140
6130     I(K1)=I(K1)-100
6140 NEXT K1
6150 RETURN
8000 REM ---READ STRUCTURE FILE---
8005 O9=15
8010 READ :1: I$
8015 CHANGE I$ TO I
8020 GOSUB 6100
8025 FOR Y=0 TO I(0)
8030   H(Y)=I(Y)
8035 NEXT Y
8045 FOR T2=1 TO H(3)
8050   READ :1: I$
8055   CHANGE I$ TO I
8060   GOSUB 6100
8065   T3=I(2)
8070   FOR T1=1 TO 16
8075     F(T1,T3)=I(T1)
8080   NEXT T1
8095 NEXT T2
8265 RETURN
8500 REM ----- READ .COA HEADER ---------
8510 READ :4: G1$
8520 CHANGE G1$ TO I
8530 GOSUB 6100
8550 G2=I(11)
8560 G3=I(12)
8570 G4=I(13)
8580 G5=I(14)
8590 G6=I(15)
8600 G7=I(16)
8610 SET :4, LOC(4)+1		'  BUMP PAST DUMMY RECORD
8690 RETURN
9000 REM -------- SYSTEM ERROR --------
9010 PRINT "* PROGRAM ERROR * UPDATE *"
9020 STOP
9999 END
