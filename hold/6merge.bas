110 '	M E R G E
120 '
140 '   COMPANY PROPRIETARY, LUPFER & LONG COMPUTER SERVICES
150 '
160 '   VERSION 1.0
170 '
180 DIM E(16,15),G(72)
190 DIM F(16,15),N$(15),H(72)
200 DIM I(132),O(132)
210 DIM F$(10),T$(4)
220 '
230 FILE #1, "COMCOM.TMP"
240 MAT READ #1, F$
280 '
290 FILE :1: F$(3)		'  .MST
300 FILE :2: F$(4)		'  .MDT
310   SCRATCH :2
312   S$="MERGED FILE"
314   WRITE :2: S$		'  WRITE GOOD HEADER LATER
320 GOSUB 8000			'  READ LEDGER BLOCK
330 GOSUB 7500			'  COPY
340 B7$=SPACE$(G(6))
350 REM --- SET-UP INPUT FILE ---
360 IF END :1 GO TO 1400
370 IF G(2)>1 GO TO 382
380   READ :1: S$
382 GOSUB 8000			'  READ JOURNAL BLOCK
385 FILE :4: N$
388   READ :4: I$		'  SKIP HEADER
500 REM =========== BEGIN MERGE ==============
502 READ :4: I$
525 IF I$="EOF" GO TO 350
530 CHANGE I$ TO I
540 CHANGE B7$ TO O
570 O(1)=I(1)
580 O(2)=I(2)
600 REM ------ TRANSFER FIELD BY FIELD ------
610 FOR J2=1 TO O9
620 J1=F(14,J2)
630 IF J1=0 GO TO 1190
700 REM ------ DETERMINE JUSTIFICATION ------
710 S4=1
715 IF F(5,J2)=9 GO TO 1170	'  CONSTANT FIELD
720 IF E(5,J1)<>2 GO TO 800
725 IF F(5,J2)=1  GO TO 800
730 IF F(5,J2)=4  GO TO 800
740   S4=0
800 REM --- SET-UP MOVE/SHIFT PARAMETERS ----
810 K1=E(13,J1)
820 K2=F(13,J2)
830 K9=E(6,J1)
832 L1=E(6,J1)
834 L2=F(6,J2)
840 IF L1=L2 GO TO 1000
850 IF L1>L2 GO TO 900
860 '   INPUT FIELD LONGER
870 IF S4=0 GO TO 1000
880   K2=K2+L2-L1
890   GO TO 1000
900 '   RECV FIELD LONGER
910 K9=F(6,J2)
920 IF S4=0 GO TO 1000
922   T1=K1
924   K1=K1+L1-L2
926   FOR K6=T1 TO K1-1		'  LEFT FILL
928     O(K6)=ASC(0)
930   NEXT K6
1000 REM ------ MOVE / SHIFT ----------------
1010 FOR K2=K2 TO (K2+K9-1)
1020   O(K1)=I(K2)
1030   K1=K1+1
1040 NEXT K2
1050 IF E(5,J1)<>2 GO TO 1190
1060 IF F(5,J2)<>3 GO TO 1190
1070 '  RE-FORMAT DATE (INTO TEXT)
1080 K1=E(13,J1)
1090 O(K1+6)=O(K1)
1100 O(K1+7)=O(K1+1)
1110 O(K1)  =O(K1+2)
1120 O(K1+1)=O(K1+3)
1130 O(K1+3)=O(K1+4)
1140 O(K1+4)=O(K1+5)
1150 O(K1+2)=ASC(-)
1160 O(K1+5)=ASC(-)
1162   GO TO 1190
1170 CHANGE N$(J2) TO T		'  CONSTANT
1172 K1=E(13,J1)
1174 FOR K2=1 TO T(0)
1176   O(K1)=T(K2)
1178   K1=K1+1
1180 NEXT K2
1188 '
1190 NEXT J2
1200 REM ---------- RECORD DONE -------------
1210 CHANGE O TO O$
1230 WRITE :2: O$
1240 GO TO 500
1400 REM ========= WRAP-UP =================
1410 S$="EOF"
1420 WRITE :2: S$
1430 N8=1
1440 N9=LOF(2)-2
1450 REM ----- WRITE HEADER -------
1460 SET :2, 1
1470 FOR I=1 TO G(6)
1480   O(I)=0
1490 NEXT I
1500   O(0)=G(6)
1510   O(1)=INT(N8/100)
1520   O(2)=INT(N8-100*O(1))
1530   O(3)=INT(N9/100)
1540   O(4)=INT(N9-100*O(3))
1550 GOSUB 6000
1560 CHANGE O TO O$
1570 WRITE :2: O$
1700 CHAIN F$(10)+F$(9)
1800 REM =========== SUBROUTINES ================
6000 REM --- KLUDGE CHAR SET FOR PDP-10 ---
6010 FOR K1=1 TO O(0)
6020   IF O(K1)>13 GO TO 6040
6030     O(K1)=100+O(K1)
6040 NEXT K1
6050 RETURN
6100 REM ---- UNKLUDGE PDP-10 CHARS -----
6110 FOR K1=1 TO I(0)
6120   IF I(K1)<100 GO TO 6140
6130     I(K1)=I(K1)-100
6140 NEXT K1
6150 RETURN
7500 REM ----- COPY TO E( , ),G( )------------
7610 FOR Y=0 TO 72
7620   G(Y)=H(Y)
7630 NEXT Y
7640 FOR Y=0 TO O9
7660   FOR X=0 TO 16
7670     E(X,Y)=F(X,Y)
7680   NEXT X
7690 NEXT Y
7700 RETURN
7800 REM --- SPECIAL INIT ROUTINE FOR STRUCTURE DATA ---
7810 FOR Y=0 TO 72
7820   H(Y)=0
7830 NEXT Y
7840 FOR Y=0 TO O9
7850   N$(Y)=""
7860   FOR X=0 TO 16
7870     F(X,Y)=0
7880   NEXT X
7890 NEXT Y
7895 RETURN
8000 REM ---READ STRUCTURE FILE---
8004 GOSUB 7800			'  SPECIAL INIT
8005 O9=15
8010 READ :1: I$
8015 CHANGE I$ TO I
8020 GOSUB 6100
8025 FOR Y=0 TO I(0)
8030   H(Y)=I(Y)
8035 NEXT Y
8038 N$=MID$(I$,20,10)
8045 FOR T2=1 TO H(3)
8050   READ :1: I$
8055   CHANGE I$ TO I
8060   GOSUB 6100
8065   T3=I(2)
8070   FOR T1=1 TO 16
8075     F(T1,T3)=I(T1)
8080   NEXT T1
8085   T4=17
8090   N$(T3)=MID$(I$,T4,I(7))
8125 NEXT T2
8255 F(13,0)=1
8260 F(6,0)=2
8265 RETURN
9999 END
