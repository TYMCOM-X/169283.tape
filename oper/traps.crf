BTITLEDTRAPS	OVER/UNDERFLOW TRAP ROUTINE	MACRO 46-11 15:01 24-JAN-74 PAGE 1
TRAPS.MAC	14-DEC-73 15:03		V32/01	14-SEP-72	/DLH

BC				TITLE TRAPS	OVER/UNDERFLOW TRAP ROUTINE
BSUBTTLC				SUBTTL	V32/01	14-SEP-72	/DLH
BC
BC				;FROM V.32(305)	6-OCT-1971	T. EGGERS/DMN/TWE
BC				;***COPYRIGHT 1969,1970,1971,1972 DIGITAL EQUIPMENT CORP., MAYNARD, MASS.***
BC
BREENTC			000000	REENT==0	;TRAPS WILL NOT LOAD INTO HIGH SEGMENT
BC
BTC			000014	T=14	;WORKING ACCUMULATOR
BTTC			000001	TT=1
BIFEREENTLOWC			000000	IFE REENT,<LOW=0>
BIFNREENTC				IFN REENT,<LOW=16>
BPC			000017	P=17	;PUSH DOWN POINTER
BC
BFXUC		000100	000000	FXU=1B11	;FLOATING EXPONENT UNDERFLOW FLAG
BFOVC		040000	000000	FOV=1B3		;FLOATING OVERFLOW BIT
BNDVC		000040	000000	NDV=1B12	;NO DIVIDE BIT
BC
BOVEC			000010	OVE=10		;ENABLE INTEGER OVERFLOW TRAPS
BC
BC				;RESTRICTIONS ON OVTRAP ROUTINE:
BC				;	1- NO ANSWER FOR A TRAPPING INSTRUCTION MUST BE STORED,
BC				;	   INDEXED BY 17, OFF THE END OF THE PUSH DOWN LIST WHOSE
BC				;	   POINTER IS IN 17.
BC				;	2- OVTRAP DOES NOT TRACE XCT OR UUO CHAINS
BC				;	3- THERE ARE NO FIXUPS FOR INTEGER TRAPS
BC				;	4- MOVNX AND MOVMX ARE CONSIDERED INTEGER INSTRUCTIONS
BC				;	5- TRAPPING INSTRUCTION MUST NOT BE IN ACCUMULATOR T=14
BC				;	6- CRY0 AND CRY1 WILL BE PRESERVED
BC				;	7- THE UN-NORMALIZING OF UNDERFLOWS WILL NOT WORK FOR THE
BC				;	   FLOATING "LONG" MODE OR KI10 D.P. INSTRUCTIONS.
BC
BIF1C				IF1,<OPDEF KADFN [DFN]>	;THIS PRESERVES THE KA10 "DFN"
BC							;   SINCE SEARCH DEF40 REDIFINES IT FOR THE KI10
BC
BSEARCHC				SEARCH	DEF40
BENTRYTRPIN.TIMERINTAB.C				ENTRY	TRPIN.,TIMER,INTAB.
BEXTERN.JBCNIC					EXTERN	.JBCNI
BEXTERNOVPC.OVCNT.C				EXTERN	OVPC.,OVCNT.
BEXTERN.JBTPC.JBAPR.JBRELITYPM.UUOL.KA10.C				EXTERN	.JBTPC,.JBAPR,.JBREL,ITYPM.,UUOL.,KA10.
BC
BMLONC				MLON	;ENABLE MULTI LINE LITERALS
BC
BC							;PUSHJ P,TRPINI	TO INITIALIZE ALL TRAPPING
BTRPIN.SKIPEKA10.LOWC	000000'	332000	000000*	TRPIN.:	SKIPE	KA10.(LOW)	;KA-10 OR KI-10 PROCESSOR
BJRSTKATRAPC	000001'	254000	000021'		JRST	KATRAP		;KA-10 INTERRUPT SYSTEM
BMOVEITTINTAB.C	000002'	201040	000336'		MOVEI	TT,INTAB.	;BASE ADDRESS OF INTERRUPT TABLE
BHRLITTC	000003'	505040	000004		HRLI	TT,4		;CLEAR INTERRUPT SYSTEM
BINTADRTTC	000004'	047040	777745		INTADR	TT,		;INIT INTERRUPT SYSTEM
BHALTC	000005'	254200	000000		HALT
BHRLZITTC	000006'	515040	000002		HRLZI	TT,2		;REENABLE INTERRUPT SYSTEM
BINTADRTTC	000007'	047040	777745		INTADR	TT,
BHALTC	000010'	254200	000000		HALT
BHRLOITTDTRAPS	OVER/UNDERFLOW TRAP ROUTINE	MACRO 46-11 15:01 24-JAN-74 PAGE 1-2
TRAPS.MAC	14-DEC-73 15:03		V32/01	14-SEP-72	/DLH

BC	000011'	525040	777777		HRLOI	TT,777777
BINTENBTTC	000012'	047040	777744		INTENB	TT,		;ENABLE ALL CHANNELS
BHALTC	000013'	254200	000000		HALT
BMOVETTJSROVTRAPC	000014'	200040	000444'		MOVE	TT,[JSR OVTRAP]	;TRAP1 INSTRUCTION
BSETTR1TTC	000015'	047040	777740		SETTR1 TT,		;INIT OVERFLOW TRAPPING
BHALTC	000016'	254200	000000		HALT
BSETZMOVCNT.LOWC	000017'	402000	000000*		SETZM OVCNT.(LOW)	;INIT # OVERFLOWS TO 0
BPOPJPC	000020'	263740	000000		POPJ	P,		;RETURN
BKATRAPMOVEITTOVTRAPC	000021'	201040	000031'	KATRAP:	MOVEI TT,OVTRAP+1
BHRRZMTT.JBAPRC	000022'	552040	000000*		HRRZM TT,.JBAPR		;INIT OVERFLOW TRAP ADDRESS
BMOVEITTOVEC	000023'	201040	400010		MOVEI TT,OVE+400000
BJRSTFXWDC	000024'	254120	000445'		JRSTF @[XWD 004000,.+1]		;CLEAR APR FLAGS
BAPRENBTTC	000025'	047040	000016		APRENB TT,		;INIT OVERFLOW TRAPPING
BSETZMOVCNT.LOWC	000026'	402000	000017*		SETZM OVCNT.(LOW)	;INIT # OVERFLOWS TO 0
BPOPJPC	000027'	263740	000000		POPJ	P,		;RETURN
BC
BOVTRAPC	000030'	000000	000000	OVTRAP:	0
BJRSTFXWDC	000031'	254120	000446'		JRSTF	@[XWD 004000,.+1]
BMOVEMTTSAVEC	000032'	202600	000332'		MOVEM T,TSAVE		;SAVE AC T
BSKIPNKA10.LOWC	000033'	336000	000000*		SKIPN	KA10.(LOW)	;KA-10 OR KI-10
BJRSTCONTC	000034'	254000	000053'		JRST	CONT		;KI-10. TIMER NOT ON SAME INTERRUPT
BMOVE.JBTPCC	000035'	200000	000000*		MOVE	0,.JBTPC	;PROGRAM COUNTER AT INTERRUPT TIME
BMOVEMOVTRAPC	000036'	202000	000030'		MOVEM	0,OVTRAP	;PUT WHERE KI-100 PUTS IT
BSKIPNMAXTIMC	000037'	336000	000330'		SKIPN	MAXTIM		;TEST IF CLOCK TRAPPING
BJRSTCONTC	000040'	254000	000053'		JRST	CONT		;NO - NORMAL PATH
BMOVET.JBCNIC	000041'	200600	000000*		MOVE	T,.JBCNI	;GET APR STATUS
BTRNETC	000042'	602600	200110		TRNE	T,200110	;OVERFLOW?
BJRSTCONTC	000043'	254000	000053'		JRST	CONT		;YES - NORMAL PATH
BAOSTNOWTIMC	000044'	350600	000331'		AOS	T,NOWTIM	;INCREMENT TICK COUNTR
BCAMLTMAXTIMC	000045'	311600	000330'		CAML	T,MAXTIM	;TIME ELAPSED?
BJRSTNOTIMEC	000046'	254000	000326'		JRST	NOTIME		;YES - ERROR MSG
BJRSTFXWDC	000047'	254120	000447'		JRSTF	@[XWD 004000,.+1] ;CLEAR APR FLAGS
BHRRITC	000050'	541600	401010		HRRI	T,401010	;SET CLOCK AND OVERFLOW TRAPS
BAPRENBTC	000051'	047600	000016		APRENB	T,		;ENABLE
BJRSTGOC	000052'	254000	000234'		JRST	GO
BCONTSOSTOVTRAPC	000053'	370600	000030'	CONT:	SOS T,OVTRAP		;MAKE JOBTPC POINT TO INSTRUCTION
BMOVEMTOVPC.LOWC	000054'	202600	000000*		MOVEM T,OVPC.(LOW)	;SAVE PC WORD
BTLNNTFXUC	000055'	607600	000100		TLNN T,(FXU)		;FLOATING POINT UNDERFLOW?
BJRSTOVTRP1C	000056'	254000	000072'		JRST OVTRP1		;NO
BC
BHLLTTC	000057'	500614	000001		HLL T,1(T)		;YES
BTLCTJFCLC	000060'	641600	255002		TLC T,(JFCL (2))	; IS NEXT INSTRUCTION
BTLNNTC	000061'	607600	777002		TLNN T,777002		;   A JFCL (2) ?
BJRSTOVTRP2C	000062'	254000	000074'		JRST OVTRP2		;YES
BC
BLDBTPOINTTC	000063'	135600	000450'		LDB T,[POINT 9,(T),8]	;GET INSTRUCTION
BCAILETC	000064'	303600	000177		CAILE T,177		;POSSIBLE FLOATING POINT?
BJRSTTJFCL1C	000065'	254000	000222'		JRST TJFCL1		;NO
BCAIGETC	000066'	305600	000140		CAIGE T,140		;BETWEEN 140 AND 177?
BJRSTCAINTFSCC					JRST	[CAIN T,(<FSC>_-9)	;NO, FSC?
BJRSTUACC						JRST UAC		;YES
BC									;(UFA AND DFN CAN'T CAUSE UNDERFLOW)
BIFNKI10C					IFN KI10,<TRZ T,003		;CHANGE ALL KI10 D.P. ARITH TO DFAD
TRAPS	OVER/UNDERFLOW TRAP ROUTINE	MACRO 46-11 15:01 24-JAN-74 PAGE 1-3
TRAPS.MAC	14-DEC-73 15:03		V32/01	14-SEP-72	/DLH

BC						CAIN T,(<DFAD>_-9)
BC						JRST UACLNG >		;DFAD, DFSB, DFMP, DFDV
BJRSTTJFCL1C	000067'	254000	000451'			JRST TJFCL1]		;NO, PRINT ERROR MESSAGE
BANDITC	000070'	405600	000007		ANDI T,7		;MASK TO MODE BITS
BJRSTUTBLTC	000071'	254014	000167'		JRST UTBL(T)		;DISPATCH ON INSTRUCTION TYPE
BC
BC
BOVTRP1TLNNTFOVDTRAPS	OVER/UNDERFLOW TRAP ROUTINE	MACRO 46-11 15:01 24-JAN-74 PAGE 2
TRAPS.MAC	14-DEC-73 15:03		V32/01	14-SEP-72	/DLH

BC	000072'	607600	040000	OVTRP1:	TLNN T,(FOV)		;FLOATING OVERFLOW OR FLOATING DIVIDE CHECK?
BJRSTTJFCL1C	000073'	254000	000222'		JRST TJFCL1		;NO, INTEGER OVERFLOW OR DIVIDE CHECK
BOVTRP2LDBTPOINTOVTRAPC	000074'	135600	000454'	OVTRP2:	LDB T,[POINT 4,@OVTRAP,12]	;GET AC FIELD
BMOVEMTACFLDC	000075'	202600	000333'		MOVEM T,ACFLD		;SAVE AC FIELD
BMOVETOVTRAPC	000076'	200620	000030'		MOVE T,@OVTRAP		;GET INSTRUCTION
BMOVEMTINSTC	000077'	202600	000335'		MOVEM T,INST
BMOVETTSAVEC	000100'	200600	000332'		MOVE T,TSAVE
BMOVEITINSTC	000101'	201620	000335'		MOVEI T,@INST		;GET EFFECTIVE ADDRESS
BEXCHTINSTC	000102'	250600	000335'		EXCH T,INST		; AND SAVE. PICK UP INSTRUCTION
BTLCTC	000103'	641600	042000		TLC T,(042B8)		;CHANGE "MODE 2" TO "MODE 0"
BC								; AND CHANGE 140-177
BC								;   TO 100-137
BHLRTOVTRAPC	000104'	544600	000030'		HLR T,OVTRAP		;GET FLAGS IN RIGHT HALF
BTDNETNDVC	000105'	612600	000455'		TDNE T,[643B8+<NDV_-^D18>]	;SKIP FOR "TO MEMORY" AND NO NDV
BC								; NO SKIP FOR INSTRUCTIONS OUTSIDE 140-177
BC								;  (E.G. FSC,XCT,UFA,DFAD,DFSB,DFMP,DFDV)
BSKIPATACFLDC	000106'	334600	000333'		SKIPA T,ACFLD		;GET CORRECT SIGN FROM AC
BMOVETINSTC	000107'	200600	000335'		MOVE T,INST		;GET CORRECT SIGN FROM MEMORY
BMOVEMTACDATAC	000110'	202600	000334'		MOVEM T,ACDATA		;SAVE ADDRESS FOR SIGN OF CORRECT RESULT
BMOVETOVTRAPC	000111'	200600	000030'		MOVE T,OVTRAP		;IS THIS AN UNDERFLOW THAT
BTLNETFXUC	000112'	603600	000100		TLNE T,(FXU)		;  NEEDS TO BE UNNORMALIZED?
BJRSTMOVETTSAVEC					JRST	[MOVE T,TSAVE	;YES, RESTORE T AND
BMOVETACDATAC						MOVE T,@ACDATA	;  GET ANSWER THAT NEEDS UN-NORMALIZING
BPUSHPTTC						PUSH P,TT	;SAVE ANOTHER AC
BHLRETTTC						HLRE TT,T	;GET EXPONENT WITH EXTENDED SIGN INTO
BASHTTC						ASH TT,-9	;  RIGHT 8 BITS
BTSCETTTTC						TSCE TT,TT	;FOR NEGATIVE ARG, GET 1'S COMPLEMENT
BC								;OF EXPONENT AND DON'T SKIP
BTLOATC						TLOA T,777000	;FOR NEG. ARG, SET EXP TO ALL ONES
BTLZTC						TLZ T,777000	;FOR POS. ARG, SET EXP TO ALL 0'S
BCAMGETTC						CAMGE TT,[346,,346]	;WILL ALL FRACTION BITS GO AWAY?
BTDZATTC						TDZA T,T		;YES, FRACTION SHOULD BE ZERO
BASHTTTC						ASH T,400000(TT)	;UN-NORMALIZE FRACTION TO BRING EXP
BC								;BACK INTO RANGE
BPOPPTTC						POP P,TT	;RESTORE THE AC
BJRSTOVTRP3C	000113'	254000	000457'			JRST OVTRP3]	;GO STORE RESULT
BMOVETTSAVEC	000114'	200600	000332'		MOVE T,TSAVE
BSKIPGEACDATAC	000115'	335020	000334'		SKIPGE @ACDATA		;SKIP IF CORRECT RESULT IS POSITIVE
BSKIPATXWDC	000116'	334600	000474'		SKIPA T,[XWD 400000,1]	;NO, NEGATIVE
BHRLOITC	000117'	525600	377777		HRLOI T,377777		;YES
BOVTRP3PUSHPTC	000120'	261740	000014	OVTRP3:	PUSH P,T		;SAVE FIX UP
BLDBTPOINTOVTRAPC	000121'	135600	000475'		LDB T,[POINT 9,@OVTRAP,8]	;GET INSTRUCTION
BCAIGTC	000122'	307600	000177		CAIG T,177
BCAIGETC	000123'	305600	000140		CAIGE T,140		;NORMAL FLOATING POINT INSTRUCTION
BJRSTCAINTFSCC					JRST	[CAIN T,(<FSC>_-9)	;NO, FSC?
BJRSTACC						JRST AC		;YES
BCAINTUFAC						CAIN T,(<UFA>_-9)	;UFA?
BJRSTAC1C						JRST AC1
BPOPPACDATAC						POP P,ACDATA	;GET SIGN OF RESULT OFF PDL
BIFNKI10C					IFN KI10,<TRZ T,003	;CHANGE ALL KI10 D.P. ARITHMETIC TO DFAD
BC						CAIN T,(<DFAD>_-9)
BC						JRST ACDOUB >	;KI10 DFAD, DFSB, DFMP, OR DFDV
BJRSTTJFCL1C	000124'	254000	000476'			JRST TJFCL1]	;PROBABLY AN XCT
BANDITDTRAPS	OVER/UNDERFLOW TRAP ROUTINE	MACRO 46-11 15:01 24-JAN-74 PAGE 2-2
TRAPS.MAC	14-DEC-73 15:03		V32/01	14-SEP-72	/DLH

BC	000125'	405600	000007		ANDI T,7
BJRSTTBLTC	000126'	254014	000127'		JRST TBL(T)
TRAPS	OVER/UNDERFLOW TRAP ROUTINE	MACRO 46-11 15:01 24-JAN-74 PAGE 3
TRAPS.MAC	14-DEC-73 15:03		V32/01	14-SEP-72	/DLH

BC				;THIS PAGE FOR OVERFLOWS, DIVIDE CHECKS, AND UN-NORMALIZING UNDERFLOWS
BC
BTBLJRSTACC	000127'	254000	000146'	TBL:	JRST AC
BJRSTACLONGC	000130'	254000	000151'		JRST ACLONG
BJRSTMEMORYC	000131'	254000	000164'		JRST MEMORY
BJRSTBOTHC	000132'	254000	000136'		JRST BOTH
BJRSTACC	000133'	254000	000146'		JRST AC
BJRSTACC	000134'	254000	000146'		JRST AC
BJRSTMEMORYC	000135'	254000	000164'		JRST MEMORY
BC					;JRST BOTH
BC
BBOTHPUSHPPC	000136'	261757	000000	BOTH:	PUSH P,(P)		;SAVE ANOTHER COPY
BBOTH1MOVETTSAVEC	000137'	200600	000332'	BOTH1:	MOVE T,TSAVE
BPOPPACFLDC	000140'	262760	000333'		POP P,@ACFLD		;LOAD AC
BPOPPINSTC	000141'	262760	000335'		POP P,@INST		;LOAD MEMORY
BJRSTTJFCLC	000142'	254000	000221'		JRST TJFCL
BC
BAC1AOSTACFLDC	000143'	350600	000333'	AC1:	AOS T,ACFLD
BANDITC	000144'	405600	000017		ANDI T,17		;MASK AC+1 TO 4 BITS
BMOVEMTACFLDC	000145'	202600	000333'		MOVEM T,ACFLD
BACMOVETTSAVEC	000146'	200600	000332'	AC:	MOVE T,TSAVE
BPOPPACFLDC	000147'	262760	000333'		POP P,@ACFLD		;LOAD AC
BJRSTTJFCLC	000150'	254000	000221'		JRST TJFCL
BC
BACLONGMOVETACFLDC	000151'	200600	000333'	ACLONG:	MOVE T,ACFLD		;GET AC
BADDITC	000152'	271600	000001		ADDI T,1
BANDITC	000153'	405600	000017		ANDI T,17
BMOVEMTINSTC	000154'	202600	000335'		MOVEM T,INST		;PUT AC+1 INTO MEMORY ADDRESS
BPOPPACDATAC	000155'	262740	000334'		POP P,ACDATA		;GET SIGN OF ANSWER INTO BETTER PLACE
BPUSHPXWDC	000156'	261740	000504'		PUSH P,[XWD 344777,-1]	;SAVE A POS LOW WORD
BHRLOITC	000157'	525600	377777		HRLOI T,377777		;ASSUME A POSITIVE HIGH WORD
BSKIPGEACDATAC	000160'	335000	000334'		SKIPGE ACDATA		;SHOULD RESULT BE POSITIVE?
BKADFNTPC	000161'	131617	000000		KADFN T,(P)		;NO, NEGATE IT WITH KA10 DFN
BPUSHPTC	000162'	261740	000014		PUSH P,T		;PUT OTHER ARG ON PDL
BJRSTBOTH1C	000163'	254000	000137'		JRST BOTH1
BC
BMEMORYMOVETTSAVEC	000164'	200600	000332'	MEMORY:	MOVE T,TSAVE
BPOPPINSTC	000165'	262760	000335'		POP P,@INST
BJRSTTJFCLC	000166'	254000	000221'		JRST TJFCL
BC
BIFNKI10C				IFN KI10,<
BC				ACDOUB:	MOVSI T,(Z 17,)		;GET ONES IN AC FIELD
BC					AND T,@OVTRAP		;EXTRACT AC FIELD FROM FAULTING D.P. INST
BC					IOR T,[DMOVE 0,[EXP <377777,,777777>,<377777,,777777>]]
BC					SKIPGE ACDATA		;WAS OVERFLOW RESULT POSITIVE?
BC					TLC T,1000		;NO, CHANGE THE DMOVE TO DMOVN
BC					JRST UAC2 >		;GO FIXUP THE TWO AC'S
TRAPS	OVER/UNDERFLOW TRAP ROUTINE	MACRO 46-11 15:01 24-JAN-74 PAGE 4
TRAPS.MAC	14-DEC-73 15:03		V32/01	14-SEP-72	/DLH

BC				;THIS PAGE ONLY FOR ZEROING UNDERFLOWS
BC
BUTBLJRSTUACC	000167'	254000	000214'	UTBL:	JRST UAC		;ZERO AC
BJRSTUACLNGC	000170'	254000	000206'		JRST UACLNG		;ZERO AC, AC+1
BJRSTUMEMRYC	000171'	254000	000202'		JRST UMEMRY		;ZERO E
BJRSTUBOTHC	000172'	254000	000176'		JRST UBOTH		;ZERO AC,E
BJRSTUACC	000173'	254000	000214'		JRST UAC
BJRSTUACC	000174'	254000	000214'		JRST UAC
BJRSTUMEMRYC	000175'	254000	000202'		JRST UMEMRY
BC					;JRST UBOTH
BC
BUBOTHMOVETOVTRAPC	000176'	200620	000030'	UBOTH:	MOVE T,@OVTRAP		;GET OFFENDING INSTRUCTION
BTLZTC	000177'	621600	777000		TLZ T,777000		;ZERO OP CODE
BTLOTSETZBC	000200'	661600	403000		TLO T,(SETZB)		;CHANGE TO "SETZB AC,E"
BJRSTUAC2C	000201'	254000	000217'		JRST UAC2
BC
BUMEMRYMOVETOVTRAPC	000202'	200620	000030'	UMEMRY:	MOVE T,@OVTRAP
BTLZTC	000203'	621600	777740		TLZ T,777740		;ZERO OP CODE, AC FIELD
BTLOTSETZMC	000204'	661600	402000		TLO T,(SETZM)		;CHANGE TO "SETZM E"
BJRSTUAC2C	000205'	254000	000217'		JRST UAC2
BC
BUACLNGC	000206'			UACLNG:
BIFEKI10LDBTPOINTOVTRAPC	000206'	135600	000454'	IFE KI10,<LDB T,[POINT 4,@OVTRAP,12]	;GET AC FIELD
BDPBTPOINTTC	000207'	137600	000505'		DPB T,[POINT 4,T,12]	;COPY INTO AC FIELD
BADDITC	000210'	271600	000001		ADDI T,1		;CHANGE AC TO AC+1
BTRZTC	000211'	620600	000020		TRZ T,20		;MASK TO 4 BITS
BTLOTSETZBC	000212'	661600	403000		TLO T,(SETZB) >		;CHANGE TO "SETZB AC,AC+1"
BIFNKI10C				IFN KI10,<MOVSI T,(Z 17,)	;GET ONES IN AC FIELD
BC					AND T,@OVTRAP		;EXTRACT AC FIELD FROM FAULTING INST
BC					IOR T,[DMOVE 0,[EXP 0,0]] >	;SET UP A DMOVE TO CLEAR 2 AC'S
BJRSTUAC2C	000213'	254000	000217'		JRST UAC2
BC
BUACHLLZTOVTRAPC	000214'	510620	000030'	UAC:	HLLZ T,@OVTRAP		;GET OFFENDING INSTRUCTION
BTLZTC	000215'	621600	777037		TLZ T,777037		;ZERO OP CODE, XR,@, LEAVE AC
BTLOTSETZC	000216'	661600	400000		TLO T,(SETZ)		;CHANGE TO "SETZ AC,"
BUAC2EXCHTTSAVEC	000217'	250600	000332'	UAC2:	EXCH T,TSAVE		;SAVE INSTRUCTION, RESTORE T
BXCTTSAVEC	000220'	256000	000332'		XCT TSAVE		;CLEAR THE REQUIRED REGISTERS
BC
BTJFCLMOVEMTTSAVEC	000221'	202600	000332'	TJFCL:	MOVEM T,TSAVE		;SAVE T AGAIN
BTJFCL1AOSOVTRAPC	000222'	350000	000030'	TJFCL1:	AOS OVTRAP		;JOBTPC POINTS TO NEXT INSTRUCTION
BMOVETOVTRAPC	000223'	200620	000030'		MOVE T,@OVTRAP		;GET NEXT INSTRUCTION
BTLCTJFCLC	000224'	641600	255000		TLC T,(<JFCL>)		;COMPLEMENT "JFCL" BITS
BTLNETC	000225'	603600	777000		TLNE T,777000		;JFCL INSTRUCTION?
BJRSTERRPNTC	000226'	254000	000240'		JRST ERRPNT		;NO, PRINT ERROR MESSAGE
BTRNETC	000227'	602600	777777		TRNE T,-1		;ADDRESS SPECIFIED ON JFCL?
BHRRMTOVTRAPC	000230'	542600	000030'		HRRM T,OVTRAP		;YES, GO THERE
BTLNETZC	000231'	603600	000401		TLNE T,(<Z 10,(1)>)	;IS OVERFLOW BIT (OR XR1) SET IN JFCL?
BJRSTERRPNTC	000232'	254000	000240'		JRST ERRPNT		;YES, TYPE ERROR MESSAGE
BRETURNJRSTFXWDC	000233'	254120	000506'	RETURN:	JRSTF	@[XWD 004000,.+1] ;CLEAR APR FLAGS
BGOHRLOITC	000234'	525600	337600	GO:	HRLOI T,337600		;MASK OUT SOME FLAGS
BANDMTOVTRAPC	000235'	406600	000030'		ANDM T,OVTRAP		;BUT LEAVE CRY0, CRY1, AND USER IOT SET
BMOVETTSAVEC	000236'	200600	000332'		MOVE T,TSAVE		;RESTORE T
BJRSTFOVTRAPC	000237'	254120	000030'		JRSTF @OVTRAP
B%OPDTRAPS	OVER/UNDERFLOW TRAP ROUTINE	MACRO 46-11 15:01 24-JAN-74 PAGE 5
TRAPS.MAC	14-DEC-73 15:03		V32/01	14-SEP-72	/DLH

BC			700000	%OP==(7B2)
BIFEREENT%LC			000000	IFE REENT,<%L==0>
BIFNREENTC				IFN REENT,<%L==(1B5)>
B%OC			000005	%O==5
B%EC			000010	%E==10
B%%CRC			000003	%%CR==3
BC
BERRPNTMOVETOVPC.LOWC	000240'	200600	000054*	ERRPNT:	MOVE T,OVPC.(LOW)	;GET FLAGS
BTLNNTFXUC	000241'	607600	000100		TLNN T,(FXU)
BAOSOVCNT.LOWC	000242'	350000	000026*		AOS OVCNT.(LOW)		;COUNT OVERFLOWS AND DIVIDE CHECKS
BTLNNTFOVC	000243'	607600	040000		TLNN T,(FOV)		;FLOATING POINT TRAP?
BJRSTHRRITC					JRST	[HRRI T,1	;NO, ASSUME INTEGER OVERFLOW
BTLNETNDVC						TLNE T,(NDV)	;INTEGER DIVIDE CHECK?
BMOVEITC						MOVEI T,2	;YES
BJRSTMSG2C	000244'	254000	0005	JRST MSG2]
BHRRITC	000245'	541600	000003		HRRI T,3		;ASSUME FLOATING POINT OVERFLOW
BTLNETNDVC	000246'	603600	000040		TLNE T,(NDV)		;FLOATING DIVIDE CHECK?
BMOVEITC	000247'	201600	000005		MOVEI T,5		;YES
BTLNETFXUC	000250'	603600	000100		TLNE T,(FXU)		;FLOATING UNDERFLOW?
BMOVEITC	000251'	201600	000004		MOVEI T,4		;YES
BMSG2HRRZSTC	000252'	553000	000014	MSG2:	HRRZS	T		;MAKE SURE LEFT HALF IS CLEAR
BPUSHPC	000253'	261740	000001		PUSH	P,1
BPUSHPC	000254'	261740	000002		PUSH	P,2
BPUSHPC	000255'	261740	000003		PUSH	P,3
BHRRZOVPC.LOWC	000256'	550040	000240*		HRRZ	1,OVPC.(LOW)	;GET ADDRESS
BCAMG.JBRELC	000257'	317040	000000*		CAMG	1,.JBREL	;SKIP IF FROM HIGH SEGMENT
BXCTUUOL.LOWC	000260'	256000	000000*		XCT	UUOL.(LOW)	;SET UP AC16 IF REENT OP SYSTEM
BPUSHJPITYPM.C	000261'	260740	000000*		PUSHJ	P,ITYPM.
B%ET%OPC	000262'	700400	000014		%E,	T	(%OP)
B%OOVPC.%OP%L%%CRC	000263'	700263	000256*		%O,	@OVPC.	(%OP+%L+%%CR)
BHRRZOVPC.LOWC	000264'	550040	000263*		HRRZ	1,OVPC.(LOW)	;GET ADDRESS
BCAMG.JBRELC	000265'	317040	000257*		CAMG	1,.JBREL	;SKIP IF FROM HIGH SEGMENT
BXCTUUOL.LOWC	000266'	256000	000260*		XCT	UUOL.(LOW)	;RESTORE AC16 AGAIN
BPOPPC	000267'	262740	000003		POP	P,3
BPOPPC	000270'	262740	000002		POP	P,2
BPOPPC	000271'	262740	000001		POP	P,1
BJRSTRETURNC	000272'	254000	000233'		JRST	RETURN
BC
BTIMCHNC			000003	TIMCHN=3 ;INTERRUPT CHANNEL USED FOR TIMER
BC
BC				;ROUTINE TO ALLOW USER TO SPECIFY A MAXIMUM CPU TIME IN SECONDS.
BC				;CALLING SEQUENCE IS 
BC				;	CALL TIMER (TIME)
BC				;WHERE TIME IS THE MAX RUN TIME IN INTEGER SECONDS.
BC
BTIMERC	000273'	000000	000000	TIMER:	0
BMOVEC	000274'	200036	000000		MOVE	0,@0(16)	;GET TIME ARGUMENT
BIMULIC	000275'	221000	000074		IMULI	0,^D60		;CONVERT TIME TO TICKS
BMOVEMMAXTIMC	000276'	202000	000330'		MOVEM	0,MAXTIM	;STORE
BSETZMNOWTIMC	000277'	402000	000331'		SETZM	NOWTIM		;CLEAR TO DATE TIME
BSKIPEKA10.LOWC	000300'	332000	000033*		SKIPE	KA10.(LOW)
BJRSTKATIMEC	000301'	254000	000314'		JRST	KATIME
BMOVEITIMINTC	000302'	201000	000320'		MOVEI	0,TIMINT	;TIMER INTERRUPT ROUTINE
BMOVEMINTAB.TIMCHNDTRAPS	OVER/UNDERFLOW TRAP ROUTINE	MACRO 46-11 15:01 24-JAN-74 PAGE 5-2
TRAPS.MAC	14-DEC-73 15:03		V32/01	14-SEP-72	/DLH

BC	000303'	202000	000343'		MOVEM	0,INTAB.+<TIMCHN-1>*2+1 ;STORE IN INTERRUPT TABLE
BMOVEITIMCHNC	000304'	201000	000003		MOVEI	0,TIMCHN
BHRLIC	000305'	505000	000001		HRLI	0,1		;INTERRUPT CAUSE IS CLOCK INTERRUPT
BINTASSC	000306'	047000	777742		INTASS	0,		;ASSIGN CHANNEL(3) TO CAUSE(1)
BHALTC	000307'	254200	000000		HALT
BMOVETIMCHNC	000310'	200000	000513'		MOVE	0,[1B0+1B<TIMCHN>]
BINTENBC	000311'	047000	777744		INTENB	0,		;ENABLE TIMER CHANNEL
BHALTC	000312'	254200	000000		HALT
BJRAC	000313'	267716	000000		JRA	16,0(16)	;RETURN
BKATIMEJRSTFXWDC	000314'	254120	000514'	KATIME:	JRSTF	@[XWD 004000,.+1];CLEAR APR FLAGS
BMOVEIC	000315'	201000	401010		MOVEI	0,401010	;SET CLOCK AND OVERFLOW TRAPS
BAPRENBC	000316'	047000	000016		APRENB	0,		;ENABLE
BJRAC	000317'	267716	000000		JRA	16,0(16)	;RETURN
BC
BTIMINTMOVEMTTSAVEC	000320'	202600	000332'	TIMINT:	MOVEM	T,TSAVE		;NEED A REGISTER
BAOSTNOWTIMC	000321'	350600	000331'		AOS	T,NOWTIM	;INCREMENT TICK COUNTER
BCAMLTMAXTIMC	000322'	311600	000330'		CAML	T,MAXTIM	;TIME ELAPSED?
BJRSTNOTIMEC	000323'	254000	000326'		JRST	NOTIME		;YES - ERROR MESSAGE
BMOVETTSAVEC	000324'	200600	000332'		MOVE	T,TSAVE		;RESTORE REGISTER
BDISMISC	000325'	047000	777755		DISMIS			;RETURN TO PROGRAM
BNOTIMETTCALLASCIZC				NOTIME:	TTCALL	3,[ASCIZ/
BC				MAXIMUM RUN TIME EXCEEDED
BC	000326'	051140	000515'	/]
BCALLIC	000327'	047040	000012		CALLI	1,12		;EXIT WITH CHANNELS OPEN
BMAXTIMBLOCKC	000330'			MAXTIM:	BLOCK	1		;MAXIMUM RUN TIME IN TICKS
BNOWTIMBLOCKC	000331'			NOWTIM:	BLOCK	1		;RUN TIME TO DATE IN TICKS
BTSAVEBLOCKC	000332'			TSAVE:	BLOCK 1		;TEMP FOR AC T
BACFLDBLOCKC	000333'			ACFLD:	BLOCK 1		;ADDRESS OF ACCUMULATOR
BACDATABLOCKC	000334'			ACDATA:	BLOCK 1		;HOLDS SIGN OF CORRECT ANSWER
BINSTBLOCKC	000335'			INST:	BLOCK 1		;HOLDS INSTRUCTION OR "E"
BINTAB.BLOCKC	000336'			INTAB.:	BLOCK ^D70	;INTERRUPT SYSTEM TABLE
BC
BC
BREPEATDTRAPS	OVER/UNDERFLOW TRAP ROUTINE	MACRO 46-11 15:01 24-JAN-74 PAGE 6
TRAPS.MAC	14-DEC-73 15:03		V32/01	14-SEP-72	/DLH

BC				REPEAT 0,<
BC				
BC				DESCRIPTION OF "TRAPS" PROGRAM FOR LIB40-
BC				
BC				I. THE PURPOSE OF THE TRAPS PROGRAM IS DO ERROR DETECTION
BC				   AND CORRECTION WHEN ARITHMETIC FAULTS OCCUR DURING THE
BC				   EXECUTION OF FORTRAN PROGRAMS.
BC				
BC				II. THE TRAPS PROGRAM CONSISTS OF THREE DISTINCT PARTS:
BC				
BC					A. TRPINI
BC						1. CALLING SEQUENCE- PUSHJ P,TRPINI
BC										;RETURN
BC						2. THE OVERFLOW COUNTER, OVCNT, (USED BY THE OVERFL
BC						      FUNCTION) AND THE PC WORD FLAGS ARE CLEARED
BC						3. PROCESSOR AND MONITOR TRAPPING ON OVERFLOW (PC WORD
BC						      BIT 0) IS ENNABLED
BC				
BC					B. OVERFL IS THE STANDARD FORTRAN OVERFLOW FUNCTION
BC						AND EXISTS IN LIB40 AS OVERFL.
BC						1. CALLING SEQUENCE-	JSA 16,OVERFL
BC									ARG	J
BC										;RETURN
BC						2. IF OVCNT=0, THEN J_1
BC						3. IF OVCNT=/0, THEN J_2
BC						4. THE OVERFLOW COUNTER, OVCNT, IS CLEARED TO 0
BC				
BC					C. OVTRAP IS A USER-MODE INTERRUPT ROUTINE WHICH IS STARTED
BC					  BY THE MONITOR WHEN AN ARITHMETIC FAULT OCCURS
BC						1. THE PC WORD (WITH THE ADDRESS OF THE INSTRUCTION
BC						      CAUSING THE TRAP) IS STORED IN OVPC.
BC						2. FOR FLOATING POINT INSTRUCTIONS
BC							A. FOR OVERFLOWS AND DIVIDE CHECKS,
BC							    THE FAULTY ANSWER IS PATCHED
BC							   TO BE PLUS OR MINUS (THE SIGN WILL BE THAT
BC							   OF THE CORRECT ANSWER)THE LARGEST POSSIBLE
BC							   NUMBER.
BC							B. FOR UNDERFLOWS, THE FAULTY ANSWER IS NORMALLY
BC							   PATCHED TO BE 0. HOWEVER, IF THE INSTRUCTION
BC							   FOLLOWING THE TRAPPING INSTRUCTION IS A JFCL
BC							   WITH BIT 16 (XR2) SET, THE ANSWER WILL BE
BC							   UN-NORMALIZED ENOUGH TO BRING THE EXPONENT
BC							   BACK INTO RANGE.
BC						3. (FOR INTEGER INSTRUCTIONS, NO PATCHING OF ANSWERS
BC						      IS DONE.)
BC				TRAPS	OVER/UNDERFLOW TRAP ROUTINE	MACRO 46-11 15:01 24-JAN-74 PAGE 7
TRAPS.MAC	14-DEC-73 15:03		V32/01	14-SEP-72	/DLH

BC						4. IF THE INSTRUCTION AFTER THE TRAPPING INSTRUCTION
BC						      IS JFCL
BC						      A. DO NOT TYPE AN ERROR MESSAGE
BC							 UNLESS BIT 9 (AR OV TEST BIT) OR 17 (XR1) IS 1
BC						      B. DO NOT INDEX THE OVERFLOW COUNTER OVCNT
BC						      C. IF THE ADDRESS (BITS 18-35) OF THE JFCL
BC							 ARE NON-ZERO, THE INTERRUPTED PROGRAM WILL
BC							 BE RESTARTED AT THE ADDRESS OF THE JFCL
BC							  (THE @ AND INDEX FIELDS ARE IGNORED).
BC						      D. IF THE ADDRESS OF THE JFCL IS ZERO, THE
BC							 INTERRUPTED PROGRAM WILL BE RESTARTED AT
BC							 THE JFCL
BC							E. IF BIT 16 (XR2) IS A 1, UN-NORMALIZE THE
BC							   FRACTION BITS FOR UNDERFLOWS IN ORDER TO
BC							   BRING THE EXPONENT BACK INTO RANGE.
BC						5. IF THE INSTRUCTION AFTER THE TRAPPING INSTRUCTION
BC						      IS NOT JFCL
BC						      A. INDEX THE OVERFLOW COUNTER, OVCNT
BC						      B. TYPE AN ERROR MESSAGE, USING SUBROUTINE "ERRMSG",
BC							 OF THE FOLLOWING FORM:
BC				
BC							INTEGER     OVERFLOW
BC							FLOATING    UNDERFLOW	PC=NNNNNN
BC							FLOATING    DIVIDE CHECK
BC				
BC						      C. THE INTERRUPTED PROGRAM WILL BE RESTARTED AT
BC							 THE INSTRUCTION AFTER THE TRAPPING INSTRUCTION
BC						6. THE PROCESSOR FLAGS (PC WORD FLAGS) ARE CLEARED
BC							EXCEPT FOR CRY0 AND CRY1.
BC						7. THE INTERRUPTED PROGRAM IS RESTARTED
BC				
BC				TRAPS	OVER/UNDERFLOW TRAP ROUTINE	MACRO 46-11 15:01 24-JAN-74 PAGE 8
TRAPS.MAC	14-DEC-73 15:03		V32/01	14-SEP-72	/DLH

BC				III. LIMITATIONS
BC				
BC					A. OVTRAP FIXUPS WILL NOT WORK ON THE PDP-6 FOR-
BC						1. THE LOW ORDER WORD OF FXXRL OR FXXL INSTRUCTIONS
BC						2. EXPONENT UNDERFLOW OR DIVIDE CHECK TRAPS
BC				
BC					B. FLOATING POINT FIX UPS WILL NOT OCCUR FOR INSTRUCTIONS
BC					   THAT ARE EXECUTED BY AN XCT OR A UUO, OR FOR INSTRUCTIONS
BC					   THAT ARE IN ACCUMULATOR T=14
BC				
BC				
BC					C. THE MEMORY FIX UPS FOR THE FLOATING POINT INSTRUCTIONS
BC					   WILL NOT WORK PROPERLY IF THE ANSWER IS STORED INDEXED
BC					   BY 17 (THE PUSH DOWN POINTER). EXAMPLES:
BC				
BC							FADRM AC,(17)
BC							FMPRB AC,-2(17)
BC							FDVM  AC,+1(17)
BC				
BC					D. MOVNX AND MOVMX ARE INTEGER INSTRUCTIONS AND WILL HAVE
BC					   NO FLOATING POINT FIX UPS IF THEY CAUSE OVERFLOW
BC					E. TRAPPING INSTRUCTION MUST NOT BE IN ACCUMULATOR T=14
BC					F. THE SIGN OF F.P. DIVIDE CHECK FIX UPS WILL BE CORRECT
BC					    ONLY WHEN DIVIDING BY ZERO. (THIS IMPLIES THAT THE
BC					    ARGUMENTS FOR DIVIDE CHECKS SHOULD BE NORMALIZED.)
BC				
BC				>	;END REPEAT 0
BC
BPRGENDC				PRGEND
BTRAPS	OVER/UNDERFLOW TRAP ROUTINE	MACRO 46-11 15:01 24-JAN-74
TRAPS.MAC	14-DEC-73 15:03		C
NO ERRORS DETECTED
PROGRAM BREAK IS 000523
3K CORE USED
TRAPS	OVER/UNDERFLOW TRAP ROUTINE	MACRO 46-11 15:01 24-JAN-74 PAGE 9
TRAPS.MAC	14-DEC-73 15:03		SYMBOL TABLE

AC		000146'		UAC		000214'		
AC1		000143'		UAC2		000217'		
ACDATA		000334'		UACLNG		000206'		
ACFLD		000333'		UBOTH		000176'		
ACLONG		000151'		UMEMRY		000202'		
APRENB	047000	000016		UTBL		000167'		
BOTH		000136'		UUOL.		000266'	EXT	
BOTH1		000137'		%%CR		000003	SPD	
CONT		000053'		%E		000010	SPD	
DISMIS	047000	777755		%L		000000	SPD	
ERRPNT		000240'		%O		000005	SPD	
FOV	040000	000000		%OP		700000	SPD	
FXU	000100	000000		.JBAPR		000022'	EXT	
GO		000234'		.JBCNI		000041'	EXT	
INST		000335'		.JBREL		000265'	EXT	
INTAB.		000336'	ENT	.JBTPC		000035'	EXT	
INTADR	047000	777745				000000		
INTASS	047000	777742		
INTENB	047000	777744		
ITYPM.		000261'	EXT	
KA10.		000300'	EXT	
KADFN	131000	000000		
KATIME		000314'		
KATRAP		000021'		
KI10		000000	SPD	
LOW		000000		
MAXTIM		000330'		
MEMORY		000164'		
MSG2		000252'		
NDV	000040	000000		
NOTIME		000326'		
NOWTIM		000331'		
OVCNT.		000242'	EXT	
OVE		000010		
OVPC.		000264'	EXT	
OVTRAP		000030'		
OVTRP1		000072'		
OVTRP2		000074'		
OVTRP3		000120'		
P		000017		
REENT		000000	SPD	
RETURN		000233'		
SETTR1	047000	777740		
T		000014		
TBL		000127'		
TIMCHN		000003		
TIMER		000273'	ENT	
TIMINT		000320'		
TJFCL		000221'		
TJFCL1		000222'		
TRPIN.		000000'	ENT	
BTITLEDONINT  ON/OFF INTERRUPT PROCESSING	MACRO 46-11 15:01 24-JAN-74 PAGE 10
TRAPS.MAC	14-DEC-73 15:03	

BC	000000'			TITLE ONINT  ON/OFF INTERRUPT PROCESSING
BC
BREENTC			000000	REENT==0
BIFEREENTLOWC			000000	IFE REENT,<LOW=0>
BIFNREENTC				IFN REENT,<LOW=16>
BC
BESCCHNC			000002	ESCCHN=2 ;CHANNEL FOR ESCAPE INTERRUPT
BC
BENTRYONINTOFFINTC				ENTRY ONINT,OFFINT
BEXTERNINTAB.TRAPF.C				EXTERN INTAB.,TRAPF.
BC
BC				;THE ROUTINE ONINT(LABEL) ASSIGNS 'LABEL' AS THE LOCATION TO GO TO
BC				;WHEN AN ESCAPE IS HIT.  THE CALL OFFINT OF NO ARGUMENTS REMOVES THIS
BC				;ASSIGNMENT.
BC
BONINTC	000000'	000000	000000	ONINT:	0
BHRRZC	000001'	550016	000000		HRRZ	0,0(16)	;GET ESCAPE LABEL
BMOVEMESCLABC	000002'	202000	000031'		MOVEM	0,ESCLAB	;SAVE FOR WHEN ESCAPE IS HIT
BMOVEIESCINTC	000003'	201000	000024'		MOVEI	0,ESCINT	;ADDRESS OF ESCAPE PROCESSOR
BMOVEMINTAB.ESCCHNC	000004'	202000	000003*		MOVEM	0,INTAB.+<ESCCHN-1>*2+1 ;STORE IN CHANNEL TABLE
BAOSTRAPF.LOWC	000005'	350000	000000*		AOS	TRAPF.(LOW)	;SIGNAL THAT TRAP ARMED
BMOVEIC	000006'	201000	777777		MOVEI	0,-1		;ASSIGN ESCAPE TO COMMAND PORT
BHRLIESCCHNC	000007'	505000	000002		HRLI	0,0_9+ESCCHN	;ASSIGN CAUSE 0 (ESCAPE) TO ESCAPE CHANNEL
BTINASSC	000010'	047000	777736		TINASS	0,		;ASSIGN ESCAPE INTERRUPT
BHALTC	000011'	254200	000000		HALT
BMOVEESCCHNC	000012'	200000	000032'		MOVE	0,[1B0+1B<ESCCHN>]	;ENABLE ESCAPE CHANNEL
BINTENBC	000013'	047000	777744		INTENB	0,
BHALTC	000014'	254200	000000		HALT
BJRAC	000015'	267716	000000		JRA	16,0(16)
BC
BOFFINTC	000016'	000000	000000	OFFINT:	0
BHRRZIC	000017'	551000	777777		HRRZI	0,-1
BTINASSC	000020'	047000	777736		TINASS	0,		;REMOVE ESCAPE FROM ESCAPE CHANNEL
BHALTC	000021'	254200	000000		HALT
BSOSTRAPF.LOWC	000022'	370000	000005*		SOS	TRAPF.(LOW)	;SIGNAL ESCAPE NO LONGER TRAPPED
BJRAC	000023'	267716	000000		JRA	16,0(16)
BC
BESCINTCLRBFOC	000024'	051500	000000	ESCINT:	CLRBFO			;CLEAR TTY OUTPUT BUFFER
BCLRBFIC	000025'	051440	000000		CLRBFI			;CLEAR TTY INPUT BUFFER
BMOVEESCLABC	000026'	200000	000031'		MOVE	0,ESCLAB	;GET ESCAPE LABEL
BHRRMINTAB.ESCCHNC	000027'	542000	000002*		HRRM	0,INTAB.+<ESCCHN-1>*2 ;SET IT AS WHERE TO GO AFTER ESCAPE PROCESSING
BDISMISC	000030'	047000	777755		DISMIS
BC
BESCLABBLOCKC	000031'			ESCLAB:	BLOCK	1
BPRGENDC				PRGEND
BONINT  ON/OFF INTERRUPT PROCESSING	MACRO 46-11 15:01 24-JAN-74
TRAPS.MAC	14-DEC-73 15:03		C
NO ERRORS DETECTED
PROGRAM BREAK IS 000033
3K CORE USED
ONINT  ON/OFF INTERRUPT PROCESSING	MACRO 46-11 15:01 24-JAN-74 PAGE 11
TRAPS.MAC	14-DEC-73 15:03		SYMBOL TABLE

CLRBFI	051440	000000		
CLRBFO	051500	000000		
DISMIS	047000	777755		
ESCCHN		000002		
ESCINT		000024'		
ESCLAB		000031'		
INTAB.		000000	EXT	
INTENB	047000	777744		
LOW		000000		
OFFINT		000016'	ENT	
ONINT		000000'	ENT	
REENT		000000	SPD	
TINASS	047000	777736		
TRAPF.		000022'	EXT	
BTITLEDTRULIMIT  LIMIT NUMBER OF TRU'S A PROGRAM CAN USE,	MACRO 46-11 15:01 24-JAN-74 PAGE 12
TRAPS.MAC	14-DEC-73 15:03	

BC	000000'			TITLE TRULIMIT  LIMIT NUMBER OF TRU'S A PROGRAM CAN USE,
BC
BREENTC			000000	REENT==0
BIFEREENTLOWC			000000	IFE REENT,<LOW=0>
BIFNREENTC				IFN REENT,<LOW=16>
BC
BPC			000017	P=17
BC
BTRUCHNC			000001	TRUCHN==1 ;INTERRUPT CHANNEL USED FOR TRU TRAPPING
BTIMEC			000074	TIME==^D60 ;AN INTERRUPT EVERY 60 UNITS
BUNITSC			000001	UNITS==1 ;WHERE UNITS ARE SECONDS
BC
BENTRYTRULIMTRUCK.C				ENTRY TRULIMIT,TRUCK.
BEXTERNINTAB.TRAPF.C				EXTERN INTAB.,TRAPF.
BC
BC				;THE CALL
BC				;	CALL TRULIMIT(TRUS,LABEL)
BC				;
BC				;WHERE LABEL IS WHERE TO GO TO WHEN THE PROGRAM HAS USED TRUS TRU'S.
BC
BTRULIMC	000000'	000000	000000	TRULIMIT: 0
BMOVEC	000001'	200036	000000		MOVE	0,@0(16)	;GET NUMBER OF TRU'S TO LIMIT PROGRAM TO
BIMULIC	000002'	221000	023420		IMULI	0,^D10000	;SCALE TO RANGE RETURNED BY MONITOR
BMOVEMLIMITC	000003'	202000	000062'		MOVEM	0,LIMIT		;AND SAVE FOR COMPARISON
BHRRZC	000004'	550016	000001		HRRZ	0,1(16)		;GET LABEL TO GO TO ON TRU LIMIT EXCEEDED
BMOVEMTRULABC	000005'	202000	000060'		MOVEM	0,TRULAB
BMOVEXWDC	000006'	200000	000063'		MOVE	0,[XWD -1,4]	;GET NUMBER OF TRU'S USED SO FAR
BGETTABC	000007'	047000	000041		GETTAB	0,
BHALTC	000010'	254200	000000		HALT
BADDMLIMITC	000011'	272000	000062'		ADDM	0,LIMIT		;COMPUTE TOTAL JOB LIMIT ON TRU'S FOR COMPARISON
BMOVEITRUINTC	000012'	201000	000054'		MOVEI	0,TRUINT	;ADDRESS OF TRU INTERRUPT ROUTINE
BMOVEMINTAB.TRUCHNC	000013'	202000	000001*		MOVEM	0,INTAB.+<TRUCHN-1>*2+1
BAOSTRAPF.LOWC	000014'	350000	000000*		AOS	TRAPF.(LOW)	;SIGNAL THE A TRAP IS SET FOR FORSE
BMOVEIC	000015'	201000	000000		MOVEI	0,0		;CLEAR ANY CURRENT TIMER
BSETTIMC	000016'	047000	777741		SETTIM	0,
BHALTC	000017'	254200	000000		HALT
BMOVEITRUCHNC	000020'	201000	000001		MOVEI	0,TRUCHN	;INTERRUPT CHANNEL FOR TRU TRAPPING
BHRLIC	000021'	505000	000004		HRLI	0,4		;INTERRUPT CAUSE IF TIMER (4)
BINTASSC	000022'	047000	777742		INTASS	0,		;ASSIGN INTERRUPT CHANNEL TO CAUSE
BHALTC	000023'	254200	000000		HALT
BMOVETRUCHNC	000024'	200000	000064'		MOVE	0,[1B0+1B<TRUCHN>]
BINTENBC	000025'	047000	777744		INTENB	0,		;ENABLE TIMER INTERRUPT
BHALTC	000026'	254200	000000		HALT
BMOVEITIMEC	000027'	201000	000074		MOVEI	0,TIME		;SET TIMER FOR 'TIME' 'UNITS'
BHRLIUNITSC	000030'	505000	000001		HRLI	0,UNITS
BSETTIMC	000031'	047000	777741		SETTIM	0,
BHALTC	000032'	254200	000000		HALT
BJRAC	000033'	267716	000000		JRA	16,0(16)
BC
BTRUCK.C	000034'	000000	000000	TRUCK.:	0
BMOVEMSAVEC	000035'	202000	000061'		MOVEM	0,SAVE		;SAVE A REGISTER
BMOVEXWDC	000036'	200000	000063'		MOVE	0,[XWD -1,4]	;GET NUMBER OF TRU'S
BGETTABC	000037'	047000	000041		GETTAB	0,
BHALTDTRULIMIT  LIMIT NUMBER OF TRU'S A PROGRAM CAN USE,	MACRO 46-11 15:01 24-JAN-74 PAGE 12-2
TRAPS.MAC	14-DEC-73 15:03	

BC	000040'	254200	000000		HALT
BCAMLLIMITC	000041'	311000	000062'		CAML	0,LIMIT		;HAS LIMIT BEEN EXCEEDED
BJRSTEXCEEDC	000042'	254000	000052'		JRST	EXCEED		;YES
BMOVETRUCK.C	000043'	200700	000034'		MOVE	16,TRUCK.	;RESTORE REGISTER USED FOR CALL
BMOVEITIMEC	000044'	201000	000074		MOVEI	0,TIME
BHRLIUNITSC	000045'	505000	000001		HRLI	0,UNITS
BSETTIMC	000046'	047000	777741		SETTIM	0,		;RESET TIMER
BHALTC	000047'	254200	000000		HALT
BMOVESAVEC	000050'	200000	000061'		MOVE	0,SAVE		;RESTORE REGISTER
BDISMISC	000051'	047000	777755		DISMIS			;RETURN TO PROGRAM
BEXCEEDMOVESAVEC	000052'	200000	000061'	EXCEED:	MOVE	0,SAVE		;RESTORE REGISTER
BJRAC	000053'	267716	000000		JRA	16,0(16)
BC
BTRUINTJSATRUCK.C	000054'	266700	000034'	TRUINT:	JSA	16,TRUCK.	;IS LIMIT EXCEEDED
BMOVETRULABC	000055'	200000	000060'		MOVE	0,TRULAB	;LABEL TO GO TO ON LIMIT EXCEEDED
BHRRMINTAB.TRUCHNC	000056'	542000	000000*		HRRM	0,INTAB.+<TRUCHN-1>*2
BDISMISC	000057'	047000	777755		DISMIS
BC
BTRULABBLOCKC	000060'			TRULAB:	BLOCK	1
BSAVEBLOCKC	000061'			SAVE:	BLOCK	1
BLIMITBLOCKC	000062'			LIMIT:	BLOCK	1
BC
BPRGENDC				PRGEND
BTRULIMIT  LIMIT NUMBER OF TRU'S A PROGRAM CAN USE,	MACRO 46-11 15:01 24-JAN-74
TRAPS.MAC	14-DEC-73 15:03		C
NO ERRORS DETECTED
PROGRAM BREAK IS 000065
3K CORE USED
TRULIMIT  LIMIT NUMBER OF TRU'S A PROGRAM CAN USE,	MACRO 46-11 15:01 24-JAN-74 PAGE 13
TRAPS.MAC	14-DEC-73 15:03		SYMBOL TABLE

DISMIS	047000	777755		
EXCEED		000052'		
GETTAB	047000	000041		
INTAB.		000056'	EXT	
INTASS	047000	777742		
INTENB	047000	777744		
LIMIT		000062'		
LOW		000000		
P		000017		
REENT		000000	SPD	
SAVE		000061'		
SETTIM	047000	777741		
TIME		000074	SPD	
TRAPF.		000014'	EXT	
TRUCHN		000001	SPD	
TRUCK.		000034'	ENT	
TRUINT		000054'		
TRULAB		000060'		
TRULIM		000000'	ENT	
UNITS		000001	SPD	
BTITLEDINTENA	ENABLE AND DISABLE INTERRUPTS	MACRO 46-11 15:01 24-JAN-74 PAGE 14
TRAPS.MAC	14-DEC-73 15:03	

BC	000000'			TITLE INTENA	ENABLE AND DISABLE INTERRUPTS
BC
BENTRYINTENAINTDISC				ENTRY	INTENA,INTDIS
BEXTERNENAB.DISAB.C				EXTERNAL	ENAB.,DISAB.
BC
BPC			000017	P==17	;PUSHDOWN POINTER
BC
BC				; CALL INTDISABLE      DISABLE THE ESCAPE AND TRU INTERRUPTS
BC				;
BC				; CALL INTENABLE       ENABLE BOTH INTERRUPTS
BC
BINTENAC	000000'	000000	000000	INTENA:	0
BPUSHJPENAB.C	000001'	260740	000000*		PUSHJ	P,ENAB.
BJRAC	000002'	267716	000000		JRA	16,0(16)
BC
BINTDISC	000003'	000000	000000	INTDIS:	0
BPUSHJPDISAB.C	000004'	260740	000000*		PUSHJ	P,DISAB.
BJRAC	000005'	267716	000000		JRA	16,0(16)
BC
BENDC					END
BINTENA	ENABLE AND DISABLE INTERRUPTS	MACRO 46-11 15:01 24-JAN-74
TRAPS.MAC	14-DEC-73 15:03		C
NO ERRORS DETECTED
PROGRAM BREAK IS 000006
3K CORE USED
INTENA	ENABLE AND DISABLE INTERRUPTS	MACRO 46-11 15:01 24-JAN-74 PAGE 15
TRAPS.MAC	14-DEC-73 15:03		SYMBOL TABLE

DISAB.		000004'	EXT	
ENAB.		000001'	EXT	
INTDIS		000003'	ENT	
INTENA		000000'	ENT	
P		000017	SPD	
    +l#Jà