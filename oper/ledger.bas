100 '
110 '     L E D G E R
120 '
130 '     USES MERGED DATA FILE (.MDT) AND CHART OF ACCOUNTS (.COA)
140 '     TO PRODUCE A LEDGER REPORT IN FORM SPECIFIED BY .RPT FILE.
150 '
160 '     COPYRIGHT 1973, LUPFER & LONG COMPUTER SERVICES
170 '
180 DIM I(132),O(132),D(16),T(132)
190 DIM R(16,15)
200 DIM F$(10)
210 DIM G(4,15),G$(5)
220 DIM A(12,10)
230 DIM H(72),H$(5)
240 '
245 REM ========= FILES =================
250 FILE #3, "COMCOM.TMP"
270 FOR X=1 TO 10
280   READ #3, F$(X)
290 NEXT X
310 FILE :4: F$(5)		'  .COA
320   GOSUB 8500
330 FILE :1: F$(6)		'  .RPT
340   GOSUB 7500
350 FILE :2: F3$		'  .MDT
570 READ :2: S1$
580 REM ======== INITIALIZE =============
590 FOR Y=H(1) TO 1 STEP -1
600   IF R(2,Y)<>1 GO TO 620
610     F1=Y
620   IF R(2,Y)<>7 GO TO 632
630     F2=Y
632   IF R(2,Y)<>5 GO TO 640
634     F4=Y
640 NEXT Y
650 P6=68
660 P8=69
670 P7=0
675 '   SPECIAL PRINT POSITIONS (ENDING)
680 C1$="OPENING BALANCE"
690 C2$="CLOSING BALANCE"
700 V2=20
710 IF F4=0 GO TO 725
715 IF R(8,F2)-R(8,F4)<15 GO TO 725
720   V2=R(8,F4)+14
725 V1=(V2-15)+G1+3+G2
730 V3=R(9,F2)
735 V4=V3+2
800 '
810 GOSUB 2150
820 B7$=SPACE$(72)
830 CHANGE B7$ TO O
840 REM ======== PRINT OPENING BALANCE =======
850 GOSUB 8700			'  GET .COA RECORD
860 IF S1=1 GO TO 1640
870 IF G4>1 GO TO 900
880   A$(1)=G$(3)
890   GO TO 910
900 A$(1)=MID$(G$(5),10*(G4-1),10)
910 A$(2)=MID$(G$(5),10*G4,10)
915 GOSUB 4000
920 G$(1)=RIGHT$(G$(1),G1)
930 S$=G$(1)+"   "+G$(4)
940 CHANGE S$ TO T
950 T1=V1
960 GOSUB 2020
970 GOSUB 4000
980 GOSUB 4000
990 CHANGE C1$ TO T
1000 T1=V2
1010 GOSUB 2020
1020 CHANGE A$(1) TO T
1030 GOSUB 3000
1040 T1=V3
1050 GOSUB 2080
1060 GOSUB 4000
1070 REM ======== PRINT DETAILS ===============
1080 IF C$>G$(1) THEN 1480
1082 REM ------- JOURNAL ENTRY # -------
1084 IF H(6)=0 GO TO 1100
1086 T=100*(I(1)-20)+(I(2)-20)
1088 FOR K2=H(6)+3 TO H(6) STEP -1
1090   T2=T-INT(T/10)*10
1092   O(K2)=ASC(0)+T2
1094   T=INT(T/10)
1096   IF T=0 GO TO 1100
1098 NEXT K2
1100 REM ------- INSERT FIELDS --------
1102 FOR Y=1 TO H(1)
1104   IF R(8,Y)=0 GO TO 1430
1110   IF R(2,Y)=F1 THEN 1430
1120   T6=R(11,Y)
1130 '   - NUMERIC OR STRING -
1140   IF R(3,Y)>2 THEN 1200
1150   FOR Z=1 TO R(4,Y)
1160     T(Z)=I(T6+Z-1)
1170   NEXT Z
1180     GO TO 1400
1190 '   - DATE -
1200   IF R(3,Y)<>3 THEN 1310
1210   T(1)=I(T6+2)
1220   T(2)=I(T6+3)
1230   T(4)=I(T6+4)
1240   T(5)=I(T6+5)
1250   T(7)=I(T6)
1260   T(8)=I(T6+1)
1270   T(3)=ASC(-)
1280   T(6)=ASC(-)
1290     GO TO 1400
1300 '   - AMOUNT -
1310   IF R(3,Y)<>4 THEN 9000
1320   FOR Z=T6 TO T6+R(4,Y)-1
1330     T(Z-T6+1)=I(Z)
1340   NEXT Z
1350   T(0)=R(4,Y)
1360   T1=R(9,Y)
1370   GOSUB 2080
1380     GO TO 1430
1390 '   - COMMON -
1400   T(0)=R(5,Y)
1410   T1=R(9,Y)
1420   GOSUB 2020
1430 NEXT Y
1450 GOSUB 4000
1460 GOSUB 2150
1470   GO TO 1080
1480 REM ======= PRINT CLOSING BALANCE =======
1490 CHANGE C2$ TO T
1500 T1=V2
1510 GOSUB 2020
1530 CHANGE A$(2) TO T
1540 GOSUB 3000
1550 T1=V3
1560 GOSUB 2080
1570 O(V4)=ASC(*)
1580 P5=1
1590 PRINT
1600 P8=P8+1
1610 GOSUB 4000
1630   GO TO 840
1640 REM =========== WRAP-UP ============
1650 P1$="DONE"
1660 GOSUB 4030
1670 IF C$="ZZZZ" GO TO 2000
1680   PRINT "INCOMPLETE .MDT PASS ";C$;" ";G$(1)
1690   GO TO 9000
2000 REM --------- DONE -----------
2010 CHAIN F$(10)+F$(9)
2015 REM ========== SUBROUTINES ============
2018 '
2020 REM ---MOVE STRING TO O---
2030 T2=T1-T(0)+1
2040 FOR T3=T2 TO T1
2050   O(T3)=T(T3-T2+1)
2060 NEXT T3
2070   RETURN
2080 REM ---MOVE DOLLAR TO O---
2090 GOSUB 2280
2100 T2=T1-16+D1
2110 FOR T3=T2 TO T1
2120   O(T3)=D(T3-T2+D1)
2130 NEXT T3
2140   RETURN
2150 REM ------- READ DATA FILE (.MDT) --------
2160 IF END :2 THEN 2260
2170 READ :2: I$
2172 SET :2, LOC(2)-1		'  RETRY
2174 READ :2: S$
2175 IF I$=S$ GO TO 2180
2176   SET :2, LOC(2)-1
2177   GO TO 2170
2180 IF I$="EOF" THEN 2260
2190 CHANGE I$ TO I
2200 C$=MID$(I$,R(11,F1),R(5,F1))
2210 IF C$>=C9$ THEN 2240
2220 PRINT "FILE OUT OF SEQUENCE---CAN'T RUN LEDGER"
2230   GO TO 9000
2240 C9$=C$
2250   RETURN
2260 C$="ZZZZ"
2270   GO TO 2250
2280 REM ---DOLLAR FIELD PRINT---
2290 D1=16-T(0)-INT((T(0)-4)/3)
2300 D2=1
2310 D3=0
2320 FOR D9=1 TO 16
2330   D(D9)=32
2340   IF D9<D1 THEN 2380
2350   IF D9>8 THEN 2370
2360   ON D9 GO TO 2380,2400,2400,2400,2460,2400,2400,2400
2370   ON D9-8 GO TO 2460,2400,2400,2420,2490,2420,2420,2420
2380 NEXT D9
2390   RETURN
2400 IF D3>0 THEN 2420
2410 IF T(D2)=ASC(0) THEN 2440
2420 D(D9)=T(D2)
2430 D3=1
2440 D2=D2+1
2450   GO TO 2380
2460 IF D3=0 THEN 2480
2470 D(D9)=ASC(,)
2480   GO TO 2380
2490 D(D9)=ASC(.)
2500   GO TO 2380
2510 REM
3000 REM --------- UNPACK SIGN ---------
3010 T(0)=11
3020 T(11)=ASC(SP)
3030 IF T(10)<=ASC(9) GO TO 3060
3040   T(10)=T(10)-10
3050   T(11)=ASC(-)
3060 RETURN
4000 REM --- TOP OF PAGE/PRINT ----
4010 IF P8<59 THEN 4210
4020 IF P7=0 THEN 4070
4030 FOR P9=P8 TO 61
4040   GOSUB 4350
4050 NEXT P9
4060 PRINT TAB(31);"PAGE";P7
4070 PRINT
4080 PRINT "."
4090 PRINT
4100 P7=P7+1
4110 IF P1$="DONE" THEN 4320
4120 GOSUB 4330
4130 FOR P9=1 TO 3
4140   PRINT TAB(24);H$(P9)
4150 NEXT P9
4160 PRINT
4165 PRINT
4170 PRINT H$(4)
4180 PRINT H$(5)
4190 PRINT
4200 P8=12
4210 FOR K1=O(0) TO 1 STEP -1
4211   IF O(K1)<>32 GO TO 4214
4212 NEXT K1
4214 O(0)=K1
4216 CHANGE O TO O$
4220 PRINT O$
4230 P8=P8+1
4240 CHANGE B7$ TO O
4270 P5=0
4280 IF P5=0 THEN 4320
4290 IF P8=51 THEN 4320
4300 PRINT
4310 P8=P8+1
4320   RETURN
4330 PRINT
4340 PRINT
4350 PRINT
4360   RETURN
5000 REM ---ACCUMULATE---
5010 A1=13-T(0)
5020 A2=1
5030 IF T(13-A1)<>ASC(-) THEN 5050
5040 A2=-1
5050 FOR A8=A1 TO 11
5060   IF T(A8-A1+1)=ASC(0) THEN 5100
5070   A4=T(A8-A1+1)-48
5080   A5=INT((A2*A4)+.5)
5090   A(A8,A9)=A(A8,A9)+A5
5100 NEXT A8
5110   RETURN
5199 REM
5200 REM ---READ ACCUMULATOR---
5210 T(12)=32
5220 FOR A8=11 TO 1 STEP -1
5230   A1=0
5240   IF A(A8,A9)=0 THEN 5260
5250   A1=A(A8,A9)/10
5260   A2=INT(A1)
5270   A(A8-1,A9)=A(A8-1,A9)+A2
5280   A(A8,A9)=INT(.5+10*(A1-A2))
5290 NEXT A8
5300 IF A(0,A9)=0 THEN 5350
5310 A(11,A9)=A(11,A9)-1
5320 A(0,A9)=0
5330 T(12)=ASC(-)
5340   GO TO 5220
5350 FOR A8=1 TO 11
5360   IF T(12)<>ASC(-) THEN 5390
5370   T(A8)=ASC(0)+9-A(A8,A9)
5380     GO TO 5400
5390   T(A8)=ASC(0)+A(A8,A9)
5400 NEXT A8
5410 T(0)=12
5420 IF T(12)<>ASC(-) THEN 5450
5430 A(0,A9)=-1
5440 A(11,A9)=A(11,A9)+1
5450 FOR I=1 TO T(0)-2
5460   IF T(I)<>ASC(0) GO TO 5480
5470 NEXT I
5480 RETURN
5600 REM ---CLEAR ACCUMULATOR---
5610 FOR A8=0 TO 12
5620   A(A8,A9)=0
5630 NEXT A8
5640   RETURN
6000 REM --- KLUDGE CHAR SET FOR PDP-10 ---
6010 FOR K1=1 TO O(0)
6020   IF O(K1)>13 GO TO 6040
6030     O(K1)=100+O(K1)
6040 NEXT K1
6050 RETURN
6100 REM ---- UNKLUDGE PDP-10 CHARS -----
6110 FOR K1=1 TO I(0)
6120   IF I(K1)<100 GO TO 6140
6130     I(K1)=I(K1)-100
6140 NEXT K1
6150 RETURN
7500 REM -------- READ .RPT ----------
7505 GOSUB 8400
7510 CHANGE I$ TO I
7520 GOSUB 6100
7530 FOR K1=1 TO I(0)
7540   H(K1)=I(K1)
7550 NEXT K1
7560 F3$=MID$(I$,9,10)
7570 FOR Y=1 TO H(1)
7580   GOSUB 8400
7590   CHANGE I$ TO I
7600   GOSUB 6100		'  UN-KLUDGE
7610   FOR X=1 TO I(0)
7620     R(X,Y)=I(X)
7630   NEXT X
7660 NEXT Y
7670 FOR X=1 TO 5
7680   GOSUB 8400
7685   H$(X)=I$
7690 NEXT X
7700 H$(3)="PERIOD ENDING "+G2$
7790 RETURN
8400 REM -----READ WITH RETRY -------
8410 READ :1: I$
8420 SET :1, LOC(1)-1
8430 READ :1: S$
8440 IF I$=S$ GO TO 8490
8450   SET :1, LOC(1)-1
8460   GO TO 8410
8490 RETURN
8500 REM ----- READ .COA HEADER ---------
8510 S1=0
8520 GOSUB 8900
8521 G1$=I$
8530 CHANGE G1$ TO I
8535 GOSUB 6100
8540 G1=I(10)
8550 G2=I(11)
8560 G3=I(12)
8570 G4=I(13)
8580 G5=I(14)
8590 G6=I(15)
8600 G7=I(16)
8601 G8=I(16)
8602 S$=G1$
8604 G2$=MID$(S$,29+8*(G4-G6),8)
8610 SET :4, LOC(4)+1
8690 RETURN
8700 REM ----- READ .COA RECORD -----------
8705 SET :4, LOC(4)+G7
8710 IF LOC(4)<=LOF(4) GO TO 8800
8720   S1=1
8730   GO TO 8890
8800 GOSUB 8900
8830 G$(1)=LEFT$(I$,8)
8840 G$(2)=MID$(I$,10,4)
8850 G$(3)=MID$(I$,14,10)
8860 G$(4)=MID$(I$,24,G2)
8870 GOSUB 8900
8880 G$(5)=I$
8890 RETURN
8900 '   SPECIAL READ WITH RE-TRY
8910 READ :4: I$
8920 SET :4, LOC(4)-1
8930 READ :4: I2$
8940 IF I$=I2$ GO TO 8990
8960   SET :4, LOC(4)-1
8970   GO TO 8910
8990 RETURN
9000 REM ---TROUBLE---
9010 PRINT "* PROGRAM ERROR * LEDGER *"
9020 STOP
9999 END
