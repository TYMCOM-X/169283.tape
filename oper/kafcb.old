MODULE KAFCB(DOLLAR,ENTRIES=($KAFCB),FSAVE,TIMING,TIMER=EXTERNAL(SIX12))=
BEGIN

REQUIRE CDEFS.BLI[7,107355];
REQUIRE KDEFS.BLI[7,107355];

UNDECLARE $KAFCB;

GLOBAL ROUTINE $KAFCB(FID,DIRECT,MODEROUT)=
   BEGIN
   MAP KFIDT$ FID;

   IF .FID[K$DEVICE] EQL SIXBIT 'TTY'
      THEN BEGIN
         $CFREE(.FID);
         .CONTF$  END
      ELSE BEGIN
         LOCAL KFCB$ FCB;
         FCB := $CGTZM(KV$FCBS);
           BEGIN % ADD NEW FCB TO CHAIN OF FCBS %
           REGISTER KFCB$ CHAINHEAD; % BECAUSE CHAIN IN FIRST WORD %
           CHAINHEAD _ KFCBC$;       %  OF FCB THIS IS POSSIBLE      %
           FCB[K$LCHAIN] _ KFCBC$;   % INSERT AT BEGINNING %
           FCB[K$RCHAIN] _ .CHAINHEAD[K$RCHAIN];
           FCB[K$NLCHAIN] _ FCB[K$FCB];
           FCB[K$PRCHAIN] _ FCB[K$FCB];
           FCB[K$AREA] _ .CAREA$
           END;
         FCB[K$DRCT] := .DIRECT;
         FCB[K$FIDPTR] := .FID;
         $KOFCB(.FCB,.MODEROUT);
         .FCB
         END

   END;

END ELUDOM
