BLISS  V. 1.0-2.12	5-JUL-73  17:25:40	TC	TC.BLI		PAGE 1-1

BMODULETCSTACKSTACKC	 MODULE TC(STACK)=
BBEGINC	 BEGIN
BC	 
BC	 %
BC	 THIS PROGRAM IS A DEBUGGING AID WHICH IS INTENDED FOR USE WITH RPG.
BC	 THE PROGRAM MAY BE LOADED AND RUN BY ITSELF OR IT MAY BE LOADED IN
BC	 CORE WITH RPG.  IF THIS PROGRAM IS LOADED WITH RPG, RPG WILL CALL
BC	 THE ROUTINE 'RPGDB' BEFORE RUNNING ANY PROGRAM.  RPGDB WILL TYPE THE
BC	 NAME OF THE PROGRAM WHICH RPG WOULD HAVE RUN AND THEN WILL CALL TMPLIST.
BC	 IF THIS PROGRAM IS RUN BY ITSELF, ONLY TMPLIST IS CALLED.  THE ROUTINE
BC	 TMPLIST TYPES A DIRECTORY OF ALL TMPCOR:XXX AND DSK:###XXX.TMP FILES
BC	 AND THEN WAITS FOR A FILE NAME FROM THE TTY.  THE SPECIFIED FILE
BC	 IS TYPED AND THEN ANOTHER NAME IS REQUESTED.  ALL FILES ARE TYPED IN
BC	 TEXT FORMAT EXCEPT 'RPG', WHICH IS INTERPRETED AND TYPED IN A FAIRLY
BC	 READABLE FORMAT.
BC	 %
BC	 
BOWNDBBUFHBUFDBJOBNAMDOTC	 OWN BUFH[3], BUF[#406], JOBNAME, DOT;
BC	 
BEXTERNJOBFFC	 EXTERNAL JOBFF;
BC	 
BBINDRINGPTPTRCNTINCHC	 BIND RINGPTR=0, PTR=1, CNT=2, INCH=0;
BC	 
BMACROSKIPOPC	 MACRO SKIP(OP)=(VREG_1; OP; VREG_0; .VREG)$,
BMSGMESC	       MSG(MES)=TTCALL(3,PLIT ASCIZ MES)$;
BC	 
BMACHOPCALLIOPENTTCALLINSTATOSTATZC	 MACHOP CALLI=#47, OPEN=#50, TTCALL=#51, IN=#56, STATO=#61, STATZ=#63,
BINBUFRELEASLOOKUPC	        INBUF=#64, RELEASE=#71, LOOKUP=#76;
BC	 
BMACHOPJRSTJRSTMACROHALTC	 MACHOP JRST=#254; MACRO HALT=JRST(4)$;
BC	 
BROUTINTYPECHARC	 ROUTINE TYPE(CHAR)=
BC	   !TYPES .CHAR AND DOES & STUFF FOR CONTROL CHARACTERS
BIFCHARNEQTHENC	   IF .CHAR NEQ 0 THEN
BIFCHARLSSANDCHARNEQANDCHARNEQTHENC	     (IF .CHAR LSS " " AND .CHAR NEQ #15 AND .CHAR NEQ #12 THEN
BTTCALLPLITCHARCHARC	       (TTCALL(1,PLIT"&"); CHAR_.CHAR+"A"-1);
BTTCALLCHARC	     TTCALL(1,CHAR));
BC	 
BROUTINDBTYPSIXTXTC	 ROUTINE TYPSIX(TXT)=
BC	   !TYPES THE SIXBIT MESSAGE IN .TXT
BBEGINREGISTPTC	   BEGIN REGISTER P,T;
BPTXTC	     P_TXT<36,6>;
BDECRIFROMTOIDOIFTSCANIPNEQTHENTYPETC	     DECR I FROM 6 TO 1 DO IF (T_SCANI(P)) NEQ 0 THEN TYPE(.T+" ");
BENDC	   END;
BC	 
BROUTINDBTYPNUMNUMBASEC	 ROUTINE TYPNUM(NUM,BASE)=
BC	   !TYPES THE NUMBER .NUM IN BASE .BASE
BBEGINREGISTRC	   BEGIN REGISTER R;
BRNUMMODBASENUMNUMBASEC	     R_.NUM MOD .BASE; NUM_.NUM/.BASE;
BIFNUMGTRTHENTYPNUMNUMBASEC	     IF .NUM GTR 0 THEN TYPNUM(.NUM,.BASE);
BTYPERC	     TYPE(.R+"0");
BENDC	   END;
BC	 
BROUTINDBRDSIXMAXC	 ROUTINE RDSIX(MAX)=
BC	   !READS A MAXIMUM OF .MAX SIXBIT CHARACTERS FROM THE TTY.  IF A DOT
BC	   !APPEARS ANYWHERE, SETS DOT_1.  IF CONTROL-S APPEARS ANYWHERE,
BC	   !RESTARTS FROM @JOBSA.
BLISS  V. 1.0-2.12	5-JUL-73  17:25:43	TC	TC.BLI		PAGE 1-2

BBEGINREGISTTXTTPEXTERNJOBSAC	   BEGIN REGISTER TXT,T,P; EXTERNAL JOBSA;
BTXTPTXTDOTC	     TXT_0; P_TXT<36,6>; DOT_0;
BWHILETTCALLTTNEQDOIFTEQLTHENDOTELSEC	     WHILE (TTCALL(4,T); .T) NEQ #12 DO IF .T EQL "." THEN DOT_1 ELSE
BIFTEQLTHENMSGTTCALLPLITASCIZJOBSAELSEC	       IF .T EQL "?S" THEN (MSG('?M?J'); (@JOBSA)()) ELSE
BIFTTGTRTHENIFMAXMAXGEQTHENREPLACPTC	       IF (T_.T-" ") GTR 0 THEN IF (MAX_.MAX-1) GEQ 0 THEN REPLACEI(P,.T);
BTXTC	     .TXT
BENDC	   END;
BC	 
BROUTINDBRDBLKC	 ROUTINE RDBLK=
BC	   !READS A NEW DISK BLOCK.  1 IF SUCCESSFUL, 0 IF EOF.
BIFBUFHRINGPTEQLTHENELSEC	   IF .BUFH[RINGPTR] EQL 0 THEN 0 ELSE
BIFNOTSKIPVREGININCHVREGVREGTHENELSEC	     IF NOT SKIP(IN(INCH)) THEN 1 ELSE
BIFSKIPVREGSTATZINCHVREGVREGTHENELSEC	       IF SKIP(STATZ(INCH,#740000)) THEN 0 ELSE
BMSGTTCALLPLITASCIZCALLIC	         (MSG('?M?JINPUT ERROR'); CALLI(0,#12); 0);
BC	 
BROUTINDBREADC	 ROUTINE READ=
BC	   !READS ONE WORD OR CHARACTER FROM DSK OR TMPCOR INPUT BUFFER
BBEGINC	   BEGIN
BIFBUFHCNTBUFHCNTLEQTHENIFRDBLKEQLTHENRETURNC	     IF (BUFH[CNT]_.BUFH[CNT]-1) LEQ 0 THEN IF RDBLK() EQL 0 THEN RETURN -1;
BSCANIBUFHPTRC	     SCANI(BUFH[PTR])
BENDC	   END;
BC	 
BROUTINUFDREAC	 ROUTINE UFDREAD=
BC	   !ADVANCES UFD TO NEXT ENTRY.  1 IF SUCCESSFUL, 0 IF EOF.
BBEGINC	   BEGIN
BDOC	     DO
BBEGINC	       BEGIN
BBUFHPTRBUFHPTRC	         BUFH[PTR]_.BUFH[PTR]+5;
BIFBUFHCNTBUFHCNTLEQTHENIFRDBLKEQLTHENRETURNC	         IF (BUFH[CNT]_.BUFH[CNT]-5) LEQ 0 THEN IF RDBLK() EQL 0 THEN RETURN 0;
BENDC	       END
BWHILEBUFHPTREQLC	         WHILE @(.BUFH[PTR]+1) EQL 0;
BC	     1
BENDC	   END;
BC	 
BROUTINDBTYPTCDC	 ROUTINE TYPTCDIR=
BC	   !TYPE THE NAMES OF ALL FILES IN TMPCOR:
BBEGINREGISTTLOCALTCBLKC	   BEGIN REGISTER T; LOCAL TCBLK[2];
BTCBLKTCBLKTCBLKBUFC	     TCBLK[0]_0; TCBLK[1]<18,18>_-#406; TCBLK[1]<0,18>_BUF<0,0>-1;
BTTCBLKSKIPVREGCALLITVREGVREGC	     T_4^18+TCBLK<0,0>; SKIP(CALLI(T,#44));
BDECRIFROMITTODOTYPSIXBUFITYPEC	     DECR I FROM .T-1 TO 0 DO (TYPSIX(.BUF[.I]<18,18>); TYPE(" "));
BENDC	   END;
BC	 
BROUTINDBTYPDSKC	 ROUTINE TYPDSKDIR=
BC	   !TYPE THE NAMES OF ALL DSK:###NAM.TMP FILES
BBEGINREGISTLOOKBINDTLOOKC	   BEGIN REGISTER LOOK[4]; BIND T=LOOK[0];
BIFNOTSKIPVREGOPENINCHPLITSIXBITBUFHVREGVREGTHENHALTJRSTC	     IF NOT SKIP(OPEN(INCH,PLIT(#14,SIXBIT'DSK',BUFH<0,0>))) THEN HALT;
BJOBFFBUFINBUFINCHC	     JOBFF_BUF<0,0>; INBUF(INCH,2);
BCALLILOOKLOOKSIXBITLOOKLOOKC	     CALLI(LOOK[0],#24); LOOK[1]_SIXBIT'UFD'; LOOK[2]_0; LOOK[3]_1^18+1;
BIFNOTSKIPVREGLOOKUPINCHLOOKVREGVREGTHENHALTJRSTC	     IF NOT SKIP(LOOKUP(INCH,LOOK)) THEN HALT;
BWHILEUFDREANEQDOC	     WHILE UFDREAD() NEQ 0 DO
BIFBUFHPTREQLJOBNAMTHENC	       IF .(.BUFH[PTR]+1)<18,18> EQL .JOBNAME<18,18> THEN
BIFBUFHPTREQLSIXBITTHENC	         IF .(.BUFH[PTR]+2)<18,18> EQL SIXBIT"TMP" THEN
BTYPSIXBUFHPTRMSGTTCALLPLITASCIZC	           (TYPSIX(.(.BUFH[PTR]+1)<0,18>); MSG('. '));
BRELEASINCHC	     RELEASE(INCH);
BENDC	   END;
BC	 
BROUTINDBTYPDIRC	 ROUTINE TYPDIR=
BLISS  V. 1.0-2.12	5-JUL-73  17:25:52	TC	TC.BLI		PAGE 1-3

BC	   !TYPES BOTH TMPCOR AND DSK DIRECTORIES
BTYPTCDTYPDSKMSGTTCALLPLITASCIZC	   (TYPTCDIR(); TYPDSKDIR(); MSG('?M?J'));
BC	 
BROUTINDBOPENTCNAMEMODEC	 ROUTINE OPENTC(NAME,MODE)=
BC	   !READS THE FILE TMPCOR:.NAME INTO BUF AND SETS UP A FAKE BUFFER HEADER
BBEGINLOCALTCBLKREGISTTC	   BEGIN LOCAL TCBLK[2]; REGISTER T;
BBUFHRINGPTC	     BUFH[RINGPTR]_0;
BTCBLKNAMETCBLKTCBLKBUFC	     TCBLK[0]_.NAME; TCBLK[1]<18,18>_-#406; TCBLK[1]<0,18>_BUF<0,0>-1;
BTTCBLKC	     T_1^18+TCBLK<0,0>;
BIFNOTSKIPVREGCALLITVREGVREGTHENRETURNC	     IF NOT SKIP(CALLI(T,#44)) THEN RETURN 0;
BBUFHCNTTIFMODEEQLTHENELSEC	     BUFH[CNT]_.T*(IF .MODE EQL 0 THEN 5 ELSE 1);
BBUFHPTRIFMODEEQLTHENBUFELSEBUFC	     BUFH[PTR]_(IF .MODE EQL 0 THEN BUF<36,7> ELSE (BUF-1)<0,36>);
BC	     1
BENDC	   END;
BC	 
BROUTINDBOPENDSNAMEMODEC	 ROUTINE OPENDSK(NAME,MODE)=
BC	   !LOOKS UP THE FILE DSK:###(.NAME).TMP
BBEGINREGISTLOOKC	   BEGIN REGISTER LOOK[4];
BLOOKMODELOOKSIXBITLOOKBUFHC	     LOOK[0]_.MODE; LOOK[1]_SIXBIT'DSK'; LOOK[2]_BUFH<0,0>;
BIFNOTSKIPVREGOPENINCHLOOKVREGVREGTHENHALTJRSTC	     IF NOT SKIP(OPEN(INCH,LOOK)) THEN HALT;
BJOBFFBUFINBUFINCHC	     JOBFF_BUF<0,0>; INBUF(INCH,2);
BLOOKJOBNAMNAMELOOKSIXBITLOOKLOOKC	     LOOK[0]_.JOBNAME+.NAME<18,18>; LOOK[1]_SIXBIT'TMP'; LOOK[2]_LOOK[3]_0;
BSKIPVREGLOOKUPINCHLOOKVREGVREGC	     SKIP(LOOKUP(INCH,LOOK))
BENDC	   END;
BC	 
BROUTINDBTYPFNMDEVNAMEEXTPPNC	 ROUTINE TYPFNM(DEV,NAME,EXT,PPN)=
BC	   !TYPES THE FILE NAME GIVEN BY THE ARGUMENTS.
BBEGINC	   BEGIN
BIFDEVNEQSIXBITTHENTYPSIXDEVTYPEC	     IF .DEV NEQ SIXBIT'DSK' THEN (TYPSIX(.DEV); TYPE(":"));
BTYPSIXNAMEC	     TYPSIX(.NAME);
BIFEXTNEQTHENTYPETYPSIXEXTC	     IF .EXT<18,18> NEQ 0 THEN (TYPE("."); TYPSIX(.EXT<18,18>));
BIFPPNNEQTHENTYPETYPNUMPPNTYPEC	     IF .PPN NEQ 0 THEN (TYPE("["); TYPNUM(.PPN<18,18>,8); TYPE(",");
BTYPNUMPPNTYPEC	       TYPNUM(.PPN<0,18>,8); TYPE("]"));
BENDC	   END;
BC	 
BROUTINDBTYPRPGC	 ROUTINE TYPRPG=
BC	   !TYPES THE 'RPG' FILE, GIVING EACH ENTRY IN A READABLE FORMAT
BBEGINREGISTHEADTBINDMAXTYPC	   BEGIN REGISTER HEAD,T; BIND MAXTYP=2;
BWHILEHEADREADGTRDOC	     WHILE (HEAD_READ()) GTR 0 DO
BBEGINC	       BEGIN
BMSGTTCALLPLITASCIZTYPNUMHEADTYPEC	         MSG('TYPE '); TYPNUM(.HEAD<18,18>,8); TYPE(" ");
BIFHEADGTRMAXTYPTHENMSGTTCALLPLITASCIZRETURNC	         IF .HEAD<18,18> GTR MAXTYP THEN (MSG('ILLEGAL'); RETURN);
BCASEHEADOFC	         CASE .HEAD<18,18>-1 OF
BSETC	           SET
BBEGINC	 %1%         BEGIN
BMSGTTCALLPLITASCIZC	               MSG('SPECIAL RPG: ');
BIFHEADNEQTHENMSGTTCALLPLITASCIZRETURNC	               IF .HEAD<0,18> NEQ 6 THEN (MSG('WRONG LENGTH'); RETURN);
BTYPFNMREADREADREADREADREADC	               TYPFNM(READ(),READ(),READ(),(READ();READ()));
BREADC	               READ();
BENDC	             END;
BBEGINC	 %2%         BEGIN
BMSGTTCALLPLITASCIZC	               MSG('SPECIAL PROCESSORS: ');
BTHEADC	               T_.HEAD<0,18>/7;
BIFHEADMODNEQTHENMSGTTCALLPLITASCIZRETURNC	               IF .HEAD<0,18> MOD 7 NEQ 0 THEN (MSG('WRONG LENGTH'); RETURN);
BDECRIFROMITTODOC	               DECR I FROM .T TO 1 DO
BBEGINC	                 BEGIN
BIFINEQTTHENTTCALLPLITASCIZC	                   IF .I NEQ .T THEN TTCALL(3,PLIT ASCIZ', ');
BLISS  V. 1.0-2.12	5-JUL-73  17:25:58	TC	TC.BLI		PAGE 1-4

BTYPSIXREADTYPEC	                   TYPSIX(READ()); TYPE("=");
BTYPFNMREADREADREADREADREADC	                   TYPFNM(READ(),READ(),READ(),(READ();READ()));
BREADC	                   READ();
BENDC	                 END;
BENDC	             END;
BTESC	           TES;
BMSGTTCALLPLITASCIZC	         MSG('?M?J');
BENDC	       END;
BENDC	   END;
BC	 
BROUTINDBTMPLISC	 ROUTINE TMPLIST=
BC	   !THIS ROUTINE DRIVES ALMOST EVERYTHING ELSE
BBEGINREGISTNAMEMODETC	   BEGIN REGISTER NAME,MODE,T;
BCALLICALLITJOBNAMC	     CALLI(0,0); CALLI(T,#30); JOBNAME_0;
BINCRIFROMTOIBYDOJOBNAMITMODTTC	     INCR I FROM 18 TO 30 BY 6 DO (JOBNAME<.I,6>_.T MOD 10 +#20; T_.T/10);
BTYPDIRC	     TYPDIR();
BWHILETYPENAMERDSIXNEQDOC	     WHILE (TYPE(":"); NAME_RDSIX(3)) NEQ 0 DO
BBEGINC	       BEGIN
BMODEIFNAMEEQLSIXBITTHENELSEC	         MODE_(IF .NAME EQL SIXBIT'RPG' THEN #14 ELSE 0);
BIFIFIFDOTEQLTHENOPENTCNAMEMODENEQTHENELSEC	         IF (IF (IF .DOT EQL 0 THEN OPENTC(.NAME,.MODE)) NEQ 0 THEN 1 ELSE
BOPENDSNAMEMODEEQLTHENTYPEELSEC	           OPENDSK(.NAME,.MODE)) EQL 0 THEN TYPE("??") ELSE
BIFNAMEEQLSIXBITTHENTYPRPGELSEC	             IF .NAME EQL SIXBIT'RPG' THEN TYPRPG() ELSE
BWHILETREADGEQDOTYPETC	               WHILE (T_READ()) GEQ 0 DO TYPE(.T);
BMSGTTCALLPLITASCIZRELEASINCHC	         MSG('?M?J'); RELEASE(INCH);
BENDC	       END;
BENDC	   END;
BC	 
BGLOBALDBROUTINRPGDBRUNBLKC	 GLOBAL ROUTINE RPGDB(RUNBLK)=
BC	   !CALLED BY RPG - TYPES PROGRAM NAME THEN GOES TO TMPLIST
BBEGINBINDBLOCKRUNBLKC	   BEGIN BIND BLOCK[6]=.RUNBLK;
BIFBLOCKNEQTHENC	     IF .BLOCK[0] NEQ 0 THEN
BBEGINC	       BEGIN
BTTCALLPLITASCIZC	         TTCALL(3,PLIT ASCIZ'-> ');
BTYPFNMBLOCKBLOCKBLOCKBLOCKC	         TYPFNM(.BLOCK[0],.BLOCK[1],.BLOCK[2],.BLOCK[4]);
BENDC	       END;
BMSGTTCALLPLITASCIZC	     MSG('?M?J');
BTMPLISC	     TMPLIST();
BENDC	   END;
BC	 
BC	 !THE FOLLOWING CODE IS EXECUTED IF THIS IS RUN AS A STAND-ALONE PROGRAM
BC	 
BTMPLISDBC	 TMPLIST();
BCALLIC	 CALLI(1,#12);
BC	 
BENDC	 END
BELUDOMC	 ELUDOM
BENDDBBLISS  V. 1.0-2.12	5-JUL-73  17:25:58	TC	TC.BLID
MODULE LENGTH = 476+74
                                                                                                                                                                                                                                                                                                                                               