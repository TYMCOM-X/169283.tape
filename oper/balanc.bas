100 '
105 '     B A L A N C
110 '     -----------
112 '
114 '     USES .COA FILE TO PRINT VARIOUS END-OF-PERIOD REPORTS.
116 '
117 '     COPYRIGHT 1973, LUPFER & LONG COMPUTER SERVICES.
118 '
120 DIM G$(5),C$(10)
130 DIM I(132),O(132)
140 DIM A(12,8),T(50)
160 REM =========== INIT =============
162 B7$=SPACE$(72)
164 CHANGE B7$ TO O
170 P6=P8=69
230 FILE #3, "COMCOM.TMP"
240 FOR I=1 TO 10
250   READ #3, F$(I)
252 NEXT I
254 FILE :4: F$(5)		'  .COA
256   GOSUB 8500
270 H$(2)=F$(1)
280 '   DETERMINE REPORT FORMAT
285 READ T
290 FOR R=1 TO T
300   READ S$,H$(1)
310   FOR J=1 TO 6
320     READ C(J)
330   NEXT J
340   READ C9,S2
350   READ C$(1),C$(2),C$(3)
360   READ C$(9)
365   IF S$=F$(2) GO TO 380
370 NEXT R
375 GO TO 9000
380 '   CREATE HEADING
390 L$(3)="      OPENING"
400 L$(4)="      BALANCE"
410 L$(5)="        CURRENT"
411 IF H$(1)<>"TRIAL BALANCE" GO TO 420
412   L$(4)="      TO DATE"
420 FOR I=3 TO 5
430   IF C(I)=0 GO TO 470
440   CHANGE L$(I) TO T
450   V1=C(I)
460   GOSUB 2600
470 NEXT I
480 GOSUB 3200
490 CHANGE O TO H$(4)
495 H$(3)="PERIOD ENDING "+G2$
500 CHANGE B7$ TO O
510 REM =========== REPORT ===========
515 FOR J1=1 TO C9+1
516   F$=""
520   IF J1<=C9 GO TO 530
522     S3=2			'  GRAND TOTALS SWITCH/OFFSET
524     GO TO 1200
530   FOR A9=3 TO 4
540     GOSUB 5600
550   NEXT A9
552   SET :4,1
554   GOSUB 8500
560   S1$=C$(J1)
570   F$=LEFT$(S1$,1)
575   IF C9=1 GO TO 625		'  NO HEADING IF 1 CATEGORY
580   S1$ = "   " + C$(J1)
590     CHANGE S1$ TO O
600     GOSUB 4000
620     GOSUB 4000
625 REM --------- DETAIL -------------
630 GOSUB 8700                  '  READ .COA RECORD
634 IF S1=1 GO TO 1200
635 IF G4>1 GO TO 640
636   A$(1)=G$(3)
638   GO TO 650
640 A$(1)=MID$(G$(5),10*(G4-1),10)
650 A$(2)=MID$(G$(5),10*G4,10)
660 '   SELECT
670 IF C9=1 GO TO 700
680 S1$=LEFT$(G$(2),1)
690 IF S1$<>F$ GO TO 630
700 '   ACCT NO.
710 IF C(1)=0 GO TO 740
720   CHANGE G$(1) TO T
722   V3=G1
724   GOSUB 2900
730   V1=C(1)
740   GOSUB 2600
750 '   ACCT DESC.
760 IF C(2)=0 GO TO 790
770   CHANGE G$(4) TO T
775   V1=C(2)
780   GOSUB 2600
790 '   OPENING AND CLOSING
795 FOR I=3 TO 4
805   CHANGE A$(I-2) TO T
810   GOSUB 3000
820   A9=I
830   GOSUB 5000
835   IF C(I)=0 GO TO 870
840   V1=C(I)
850   GOSUB 2700
860   GOSUB 2600
870 NEXT I
900 '   CURRENT
910 IF C(5)=0 GO TO 1100
920   A9=8
925   GOSUB 5600
930   CHANGE A$(2) TO T
940   GOSUB 3000
950   GOSUB 5000
960   CHANGE A$(1) TO T
970   GOSUB 3000
980   GOSUB 3100
990   GOSUB 5000
1000   GOSUB 5200
1010   V1=C(5)
1015   GOSUB 2700
1020   GOSUB 2600
1100 '   PRINT LINE
1110 GOSUB 4000
1120 GO TO 630
1200 REM ------- SUMMARY -------------
1210 GOSUB 4000
1220 S1$ = "TOTAL " + C$(J1)
1222 IF S3=0 GO TO 1230		'  S3=1 FOR GRAND TOTALS
1223   IF S2=1 GO TO 1750
1224   S1$ = C$(9)
1226   IF F$(2)<>"PL" GO TO 1630
1228     S7=1			'  REVERSE SIGN
1230 CHANGE S1$ TO T
1240 V1=4
1250 GOSUB 2600
1300 '   OPENING AND CLOSING
1310 FOR I=3 TO 4
1330   A9=I-S3
1340   GOSUB 5200
1350   IF S3>0 GO TO 1375
1360     A9=A9-2
1370     GOSUB 5000		'  ACCUM. NET
1375   IF C(I)=0 GO TO 1410
1380   V1=C(I)-2
1390   GOSUB 2700
1392 CHANGE T TO S3$
1400   GOSUB 2600
1410 NEXT I
1500 '   CURRENT
1510 IF C(5)=0 GO TO 1700
1520   A9=4-S3
1530   GOSUB 5200
1540   A9=8
1545   GOSUB 5600
1550   GOSUB 5000
1560   A9=3-S3
1570   GOSUB 5200
1580   GOSUB 3100
1590   A9=8
1600   GOSUB 5000
1610   GOSUB 5200
1620   V1=C(5)
1630   GOSUB 2700
1640   GOSUB 2600
1700 '   PRINT
1710 O(C(6))=ASC(*)
1712   IF S3=0 GO TO 1720
1714   O(C(6)+1)=ASC(*)
1720 GOSUB 4000
1730 GOSUB 4000
1740 GOSUB 4000
1750 NEXT J1
1800 REM ====== TERMINATION ==========
1810 P1$="DONE"
1820 GOSUB 4030
1830 CHAIN F$(10)+F$(9)
2000 REM ====== SUBROUTINES ==========
2010 '
2500 REM -------- STR$ ------------
2510 FOR I=T(0) TO 1 STEP -1
2520   T2=V1-INT(V1/10)*10
2530   T(I)=ASC(0)+T2
2540   V1=INT(V1/10)
2550 NEXT I
2560 RETURN
2600 REM -------- INSERT ----------
2610 K1=1
2620 FOR K2=V1 TO V1+T(0)-1
2630   O(K2)=T(K1)
2640   K1=K1+1
2650 NEXT K2
2660 RETURN
2700 REM -------- $ FORMAT --------
2710 K1=T(0)
2720 T(0)=T(0)+INT(K1/3)
2730 FOR K2=1 TO T(0)
2740   IF INT(K2)=4*INT(K2/4) GO TO 2780
2750     T(T(0)+1-K2)=T(K1)
2760     K1=K1-1
2770     GO TO 2790
2780   T(T(0)+1-K2)=ASC(,)
2790 NEXT K2
2800 T(T(0)-3)=ASC(.)
2810 V3=4
2820 GOSUB 2900
2830 '   - REVERSE SIGN -
2840 IF F$="L" GO TO 2870
2845 IF F$="R" GO TO 2870
2848 IF S7=1 GO TO 2870
2850   GO TO 2880
2870 GOSUB 3100
2880 '  - MAKE SURE .00- DOESN'T HAPPEN -
2882 IF T(T(0)-4)<>ASC(SP) GO TO 2890
2884 IF T(T(0)-2)<>ASC(0)  GO TO 2890
2886 IF T(T(0)-1)<>ASC(0)  GO TO 2890
2888   T(T(0))=ASC(SP)
2890 RETURN
2900 REM ------ LEFT STRIP --------
2910 FOR K1=1 TO T(0)-V3
2920   IF T(K1)>ASC(0) GO TO 2950
2930   T(K1)=32
2940 NEXT K1
2950 RETURN
3000 REM --------- UNPACK SIGN ---------
3010 T(0)=11
3020 T(11)=ASC(SP)
3030 IF T(10)<=ASC(9) GO TO 3060
3040   T(10)=T(10)-10
3050   T(11)=ASC(-)
3060 RETURN
3100 REM -------- REVERSE SIGN ---------
3110 T(T(0))=T(T(0))+13
3120 IF T(T(0))=ASC(-) GO TO 3140
3130   T(T(0))=ASC(SP)
3140 RETURN
3200 REM ----- STRIP TRAILING BLANKS ---
3210 FOR K1=O(0) TO 1 STEP -1
3220   IF O(K1)<>32 GO TO 3240
3230 NEXT K1
3240 O(0)=K1
3250 RETURN
4000 REM --- TOP OF PAGE/PRINT ----
4010 IF P8<59 THEN 4210
4020 IF P7=0 THEN 4070
4030 FOR P9=P8 TO 62
4040   PRINT
4050 NEXT P9
4060 PRINT TAB(31);"PAGE";P7
4070 PRINT
4080 PRINT "."
4090 PRINT
4100 P7=P7+1
4110 IF P1$="DONE" THEN 4320
4120 GOSUB 4330
4130 FOR P9=1 TO 3
4140   PRINT TAB(24);H$(P9)
4150 NEXT P9
4160 PRINT
4165 PRINT
4170 PRINT H$(4)
4190 PRINT
4200 P8=12
4210 '   PRINT LINE
4212 GOSUB 3200
4216 CHANGE O TO O$
4220 PRINT O$
4230 P8=P8+1
4240 CHANGE B7$ TO O
4270 P5=0
4280 IF P5=0 THEN 4320
4290 IF P8=51 THEN 4320
4300 PRINT
4310 P8=P8+1
4320   RETURN
4330 PRINT
4340 PRINT
4350 PRINT
4360   RETURN
5000 REM ---ACCUMULATE---
5010 A1=13-T(0)
5020 A2=1
5030 IF T(13-A1)<>ASC(-) THEN 5050
5040 A2=-1
5050 FOR A8=A1 TO 11
5060   IF T(A8-A1+1)=ASC(0) THEN 5100
5070   A4=T(A8-A1+1)-48
5080   A5=INT((A2*A4)+.5)
5090   A(A8,A9)=A(A8,A9)+A5
5100 NEXT A8
5110   RETURN
5200 REM ---READ ACCUMULATOR---
5210 T(12)=32
5220 FOR A8=11 TO 1 STEP -1
5230   A1=0
5240   IF A(A8,A9)=0 THEN 5260
5250   A1=A(A8,A9)/10
5260   A2=INT(A1)
5270   A(A8-1,A9)=A(A8-1,A9)+A2
5280   A(A8,A9)=INT(.5+10*(A1-A2))
5290 NEXT A8
5300 IF A(0,A9)=0 THEN 5350
5310 A(11,A9)=A(11,A9)-1
5320 A(0,A9)=0
5330 T(12)=ASC(-)
5340   GO TO 5220
5350 FOR A8=1 TO 11
5360   IF T(12)<>ASC(-) THEN 5390
5370   T(A8)=ASC(0)+9-A(A8,A9)
5380     GO TO 5400
5390   T(A8)=ASC(0)+A(A8,A9)
5400 NEXT A8
5410 T(0)=12
5420 IF T(12)<>ASC(-) THEN 5450
5430 A(0,A9)=-1
5440 A(11,A9)=A(11,A9)+1
5450 RETURN
5600 REM ---CLEAR ACCUMULATOR---
5610 FOR A8=0 TO 12
5620   A(A8,A9)=0
5630 NEXT A8
5640 RETURN
6100 REM ---- UNKLUDGE PDP-10 CHARS -----
6110 FOR K1=1 TO I(0)
6120   IF I(K1)<100 GO TO 6140
6130     I(K1)=I(K1)-100
6140 NEXT K1
6150 RETURN
8500 REM ----- READ .COA HEADER ---------
8510 S1=0
8520 GOSUB 8900
8521 G1$=I$
8530 CHANGE G1$ TO I
8535 GOSUB 6100
8540 G1=I(10)
8550 G2=I(11)
8560 G3=I(12)
8570 G4=I(13)
8580 G5=I(14)
8590 G6=I(15)
8600 G7=I(16)
8601 G8=I(16)
8602 S$=G1$
8604 G2$=MID$(S$,29+8*(G4-G6),8)
8610 SET :4, LOC(4)+1
8690 RETURN
8700 REM ----- READ .COA RECORD -----------
8705 SET :4, LOC(4)+G7
8710 IF LOC(4)<=LOF(4) GO TO 8800
8720   S1=1
8730   GO TO 8890
8800 GOSUB 8900
8830 G$(1)=LEFT$(I$,8)
8840 G$(2)=MID$(I$,10,4)
8850 G$(3)=MID$(I$,14,10)
8860 G$(4)=MID$(I$,24,G2)
8870 GOSUB 8900
8880 G$(5)=I$
8890 RETURN
8900 '   SPECIAL READ WITH RE-TRY
8910 READ :4: I$
8920 SET :4, LOC(4)-1
8930 READ :4: I2$
8940 IF I$=I2$ GO TO 8990
8960   SET :4, LOC(4)-1
8970   GO TO 8910
8990 RETURN
9000 REM ---------- SYSTEM ERROR -----------
9002 PRINT "* PROGRAM ERROR * BALANC *"
9004 STOP
9006 '
9007 DATA 3		'  NO. OF POSSIBLE REPORTS
9008 '
9010 DATA BS,"BALANCE SHEET"
9020 DATA 0,6,0,33,0,48
9030 DATA 2,1
9040 DATA ASSETS,LIABILITIES," "
9050 DATA NET
9060 '
9070 DATA PL,"PROFIT AND LOSS"
9080 DATA 0,6,0,33,0,48
9090 DATA 2,0
9100 DATA REVENUE,EXPENSE," "
9110 DATA PROFIT
9120 '
9130 DATA TB,"TRIAL BALANCE"
9140 DATA 1,11,0,48,32,62
9150 DATA 1,1
9160 DATA " "," "," "
9170 DATA NET
9999 END
    